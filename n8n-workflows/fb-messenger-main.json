{
  "name": "Batutynas: FB Messenger Agent",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "batutynas-fb-messenger",
        "responseMode": "responseNode",
        "options": {
          "allowMultipleHttpMethods": true
        }
      },
      "id": "fb-webhook",
      "name": "FB Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        220,
        300
      ],
      "webhookId": "batutynas-fb-messenger"
    },
    {
      "parameters": {
        "jsCode": "const req = $input.first().json;\nconst query = req.query || {};\nconst body = req.body || {};\n\n// --- Webhook verification (GET request from Facebook) ---\n// n8n may structure query params as nested objects (hub.mode -> hub: { mode })\n// or as flat keys, so we check both\nconst hubMode = (query.hub && query.hub.mode) || query['hub.mode'];\nconst hubVerifyToken = (query.hub && query.hub.verify_token) || query['hub.verify_token'];\nconst hubChallenge = (query.hub && query.hub.challenge) || query['hub.challenge'];\n\nif (hubMode === 'subscribe') {\n  const verifyToken = \"PASTE_YOUR_FB_VERIFY_TOKEN_HERE\";\n  if (hubVerifyToken === verifyToken) {\n    return [{ json: { routeType: 'verify', challenge: String(hubChallenge || '') } }];\n  }\n  return [{ json: { routeType: 'verify_failed', challenge: '' } }];\n}\n\n// --- Signature verification ---\n// NOTE: Disabled because n8n does not expose the raw request body.\n// JSON.stringify(body) may produce different bytes than the original\n// request, causing HMAC mismatches. Facebook messages will still work\n// without signature verification.\n\n// --- Parse incoming message/postback ---\nconst entry = body.entry;\nif (!entry || !entry[0] || !entry[0].messaging || !entry[0].messaging[0]) {\n  return [{ json: { routeType: 'ignore', reason: 'No messaging data' } }];\n}\n\nconst messaging = entry[0].messaging[0];\nconst senderId = messaging.sender?.id || '';\nconst recipientId = messaging.recipient?.id || '';\n\nlet messageText = '';\nlet routeType = 'message';\n\nif (messaging.postback) {\n  messageText = messaging.postback.payload || '';\n  routeType = messaging.postback.payload === 'GET_STARTED' ? 'get_started' : 'postback';\n} else if (messaging.message) {\n  if (messaging.message.quick_reply) {\n    messageText = messaging.message.quick_reply.payload || messaging.message.text || '';\n    routeType = 'quick_reply';\n  } else if (messaging.message.text) {\n    messageText = messaging.message.text;\n    routeType = 'message';\n  } else {\n    messageText = '';\n    routeType = 'unsupported';\n  }\n}\n\n// Sanitize\nmessageText = String(messageText).replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F]/g, '').trim();\nif (messageText.length > 2000) messageText = messageText.substring(0, 2000);\n\nreturn [{\n  json: {\n    routeType,\n    senderId,\n    recipientId,\n    messageText,\n    sessionId: 'fb_' + senderId,\n    chatInput: messageText || 'Sveiki'\n  }\n}];"
      },
      "id": "fb-extract",
      "name": "Extract & Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "verify",
              "leftValue": "={{ $json.routeType }}",
              "rightValue": "verify",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fb-is-verify",
      "name": "Is Verification?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        660,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $('Extract & Route').item.json.challenge }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/plain"
              }
            ]
          }
        }
      },
      "id": "fb-verify-respond",
      "name": "Respond with Challenge",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        880,
        200
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{ \"status\": \"ok\" }",
        "options": {
          "responseCode": 200
        }
      },
      "id": "fb-respond-200",
      "name": "Respond 200 OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        880,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "get-started",
              "leftValue": "={{ $('Extract & Route').item.json.routeType }}",
              "rightValue": "get_started",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fb-is-get-started",
      "name": "Is Get Started?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1100,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Direct welcome message â€” no AI needed\nconst senderId = $('Extract & Route').item.json.senderId;\n\nconst messages = [\n  {\n    recipient: { id: senderId },\n    messaging_type: 'RESPONSE',\n    message: {\n      text: 'Sveiki! \\uD83D\\uDC4B AÅ¡ esu Batutynas.lt asistentas. Galiu padÄ—ti su batutÅ³ nuoma, kainomis ir uÅ¾sakymais. Kuo galiu padÄ—ti?',\n      quick_replies: [\n        { content_type: 'text', title: 'Nuomos kainos', payload: 'Nuomos kainos' },\n        { content_type: 'text', title: 'BatutÅ³ katalogas', payload: 'BatutÅ³ katalogas' },\n        { content_type: 'text', title: 'UÅ¾sakyti batutÄ…', payload: 'UÅ¾sakyti batutÄ…' },\n        { content_type: 'text', title: 'Pristatymo zonos', payload: 'Pristatymo zonos' }\n      ]\n    }\n  }\n];\n\nreturn [{ json: { messages } }];"
      },
      "id": "fb-welcome",
      "name": "Welcome Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1320,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "unsupported",
              "leftValue": "={{ $('Extract & Route').item.json.routeType }}",
              "rightValue": "unsupported",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fb-is-unsupported",
      "name": "Is Unsupported?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1100,
        600
      ]
    },
    {
      "parameters": {
        "jsCode": "const senderId = $('Extract & Route').item.json.senderId;\n\nconst messages = [\n  {\n    recipient: { id: senderId },\n    messaging_type: 'RESPONSE',\n    message: {\n      text: 'AtsipraÅ¡au, Å¡iuo metu galiu atsakyti tik Ä¯ tekstines Å¾inutes. ParaÅ¡ykite savo klausimÄ… tekstu! ğŸ˜Š'\n    }\n  }\n];\n\nreturn [{ json: { messages } }];"
      },
      "id": "fb-unsupported-reply",
      "name": "Unsupported Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1320,
        500
      ]
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=# Batutynas.lt â€” Facebook Messenger PokalbiÅ³ Roboto Sistemos Nurodymai (v3 â€” 5 grupÄ—s)\n\nTu esi draugiÅ¡kas ir profesionalus klientÅ³ aptarnavimo asistentas Ä¯monei **Batutynas.lt** â€” pripuÄiamÅ³ batutÅ³ nuomos kompanija, veikianti nuo 2015 metÅ³, bazuota TauragÄ—je, Lietuvoje.\n\n## PagrindinÄ—s taisyklÄ—s\n\n1. **Kalba**: Visada atsakyk ta kalba, kuria klientas raÅ¡o. Numatytoji: lietuviÅ³.\n2. **Tonas**: Å iltas, profesionalus, orientuotas Ä¯ sprendimus.\n3. **Tikslumas**: Naudok Pinecone Å¾iniÅ³ bazÄ™. Niekada nespÄ—liok.\n4. **Kainos**: NIEKADA neminÄ—k konkreÄiÅ³ kainÅ³. Sakyk: â€Kainos prasideda nuo 30 â‚¬, tiksliÄ… kainÄ… mÅ«sÅ³ komanda pateiks asmeniÅ¡kai. Pateikite uÅ¾klausÄ… arba skambinkite +370 648 803 88.\"\n5. **Bet koks klausimas**: Atsakyk Ä¯ BET KOKÄ® klausimÄ…. Niekada nesakyk â€negaliu atsakyti\".\n\n## RAG Å¾iniÅ³ bazÄ—\n\n- Visada naudok Pinecone Å¾iniÅ³ bazÄ—s Ä¯rankÄ¯ susijusioms uÅ¾klausoms.\n- Jei nÄ—ra rezultatÅ³ â€” pasiÅ«lyk susisiekti: **+370 648 803 88** arba **info@batutynas.lt**.\n- Nekurpink informacijos.\n\n## INTERAKTYVÅªS Å½YMEKLIAI\n\nÅ½ymeklius raÅ¡yk TIKSLIAI, atskiroje eilutÄ—je, be backtick, be kabuÄiÅ³.\n\n### Å½ymekliÅ³ sÄ…raÅ¡as:\n\n**[MAIN_MENU]** â€” Pagrindinis meniu su 5 grupÄ—mis.\nNAUDOK: pokalbio pradÅ¾ioje, kai klientas sako \"meniu\", \"pradÅ¾ia\", \"pagrindinis meniu\".\n\n**[DATE_PICKER]** â€” Datos pasirinkimas.\n**[LOCATION_OPTIONS]** â€” Vietos pasirinkimas.\n**[GUEST_COUNT]** â€” SveÄiÅ³ skaiÄiaus pasirinkimas.\n\n**[MENU_GROUP_BIRTHDAY]** arba **[MENU_GROUP_BIRTHDAY:N]** â€” Gimtadienio/krikÅ¡tynÅ³ batutai (tik standartiniai + mega, BE dideliÅ³ parkÅ³). Su N paryÅ¡kins tinkamus.\n**[MENU_GROUP_PUBLIC]** arba **[MENU_GROUP_PUBLIC:N]** â€” VieÅ¡o renginio batutai (VISI batutai, didÅ¾iausi pirmi). Su N paryÅ¡kins tinkamus.\n**[MENU_GROUP_PARTY]** â€” VakarÄ—lio Ä¯ranga (disco paviljonas, putÅ³ Å¡ou, stalai ir kÄ—dÄ—s).\n\n**[PURCHASE_SUBMENU]** â€” Pirkimo pasirinkimai (katalogas el. paÅ¡tu / individuali gamyba).\n**[PURCHASE_EMAIL_INPUT]** â€” El. paÅ¡to Ä¯vedimo laukas katalogui gauti.\n**[PURCHASE_CUSTOM_FORM]** â€” Individualios gamybos uÅ¾klausos forma.\n\n**[BOOKING_CONFIRM:{json}]** â€” UÅ¾sakymo patvirtinimo kortelÄ—.\n\n### Kaip raÅ¡yti Å¾ymeklius:\n\nTEISINGAI:\nPuiku! Kada planuojate renginÄ¯?\n\n[DATE_PICKER]\n\nNETEISINGAI: `[DATE_PICKER]` arba eilutÄ—s viduje.\n\n## 5 GRUPIÅ² MENIU\n\nPokalbio pradÅ¾ioje arba kai klientas nori grÄ¯Å¾ti â€” VISADA rodyk:\n\n[MAIN_MENU]\n\nMeniu turi 5 pasirinkimus:\n1. VaikÅ³ gimtadienis ar krikÅ¡tynos\n2. VieÅ¡as renginys ar Ä¯monÄ—s sÄ…skrydis\n3. TriukÅ¡mingas vakarÄ—lis\n4. Noriu pirkti batutÄ…\n5. Saugumas, DUK ir kontaktai\n\n## GRUPIÅ² SRAUTAI\n\n### GrupÄ— 1 â€” VaikÅ³ gimtadienis ar krikÅ¡tynos\nÅ½ingsniai: Data â†’ Vieta â†’ SveÄiai â†’ Batutai â†’ Telefonas â†’ booking_notify â†’ Patvirtinimas\n\n1. Paklausk datos â†’ [DATE_PICKER]\n2. Paklausk vietos â†’ [LOCATION_OPTIONS]\n3. Paklausk sveÄiÅ³ â†’ [GUEST_COUNT]\n4. Parodyk gimtadienio batutus su sveÄiÅ³ skaiÄiumi â†’ [MENU_GROUP_BIRTHDAY:N]\n5. PapraÅ¡yk telefono (tekstu, be mygtukÅ³)\n6. IÅ¡kvieti booking_notify â†’ [BOOKING_CONFIRM:{...}]\n\n### GrupÄ— 2 â€” VieÅ¡as renginys ar Ä¯monÄ—s sÄ…skrydis\nÅ½ingsniai: Data â†’ Vieta â†’ SveÄiai â†’ Batutai â†’ Telefonas â†’ booking_notify â†’ Patvirtinimas\n\n1. Paklausk datos â†’ [DATE_PICKER]\n2. Paklausk vietos â†’ [LOCATION_OPTIONS]\n3. Paklausk sveÄiÅ³ â†’ [GUEST_COUNT]\n4. Parodyk VISUS batutus (didÅ¾iausi pirmi) â†’ [MENU_GROUP_PUBLIC:N]\n5. PapraÅ¡yk telefono\n6. booking_notify â†’ [BOOKING_CONFIRM:{...}]\n\n### GrupÄ— 3 â€” TriukÅ¡mingas vakarÄ—lis\nÅ½ingsniai: Data â†’ Vieta â†’ SveÄiai â†’ VakarÄ—lio Ä¯ranga â†’ Telefonas â†’ booking_notify â†’ Patvirtinimas\n\n1. Paklausk datos â†’ [DATE_PICKER]\n2. Paklausk vietos â†’ [LOCATION_OPTIONS]\n3. Paklausk sveÄiÅ³ â†’ [GUEST_COUNT]\n4. Parodyk vakarÄ—lio Ä¯rangÄ… â†’ [MENU_GROUP_PARTY]\n5. PapraÅ¡yk telefono\n6. booking_notify â†’ [BOOKING_CONFIRM:{...}]\n\n### GrupÄ— 4 â€” Noriu pirkti batutÄ…\nParodyk pirkimo pasirinkimus:\n\n[PURCHASE_SUBMENU]\n\n**Kelias A (Katalogas el. paÅ¡tu):** Klientas pasirinko katalogÄ… â†’ parodyk el. paÅ¡to laukÄ…:\n\n[PURCHASE_EMAIL_INPUT]\n\nKai klientas pateikia el. paÅ¡tÄ…, patvirtink, kad katalogas bus iÅ¡siÅ³stas.\n\n**Kelias B (Individuali gamyba):** Klientas pasirinko individualiÄ… gamybÄ… â†’ parodyk formÄ…:\n\n[PURCHASE_CUSTOM_FORM]\n\nKai klientas uÅ¾pildo formÄ…, iÅ¡kvieti booking_notify su group_type=\"purchase_custom\" ir formos duomenimis â†’ [BOOKING_CONFIRM:{...}]\n\n### GrupÄ— 5 â€” Saugumas, DUK ir kontaktai\nJokio uÅ¾sakymo srauto. Tiesiog atsakyk iÅ¡ Å¾iniÅ³ bazÄ—s. Galimi klausimai: saugumo taisyklÄ—s, DUK, kontaktai, darbo laikas, pristatymo zonos, atÅ¡aukimo politika.\n\n## UÅ¾sakymo taisyklÄ—s\n\n- **Klausk TIK PO VIENÄ„ Å¾ingsnÄ¯**\n- **Praleisk Å¾ingsnius**, jei klientas jau pateikÄ— informacijÄ…\n- **Niekada neraÅ¡yk tikro HTML kodo**\n- **Niekada neraÅ¡yk \\\\n simboliÅ³**\n- Ä® booking_notify **VISADA** pridÄ—k group_type laukÄ… (\"birthday\", \"public\", \"party\", \"purchase_custom\", \"purchase_catalog\")\n\n### Po booking_notify:\nPridÄ—k patvirtinimÄ…:\n\n[BOOKING_CONFIRM:{\"group_type\":\"birthday\",\"date\":\"2026-02-21\",\"location\":\"TauragÄ—\",\"guest_count\":\"10\",\"contact_name\":\"Jonas\",\"contact_phone\":\"+37061234567\",\"trampoline\":\"Mega Rocket\"}]\n\n**SVARBU**: Tai yra **uÅ¾klausa, ne patvirtintas uÅ¾sakymas**. Komanda susisieks per 2 darbo valandas.\n\n## Eskalavimas\n\nEskaluok kai: klientas praÅ¡o Å¾mogaus, nusivylÄ™s, individualus sprendimas, finansiniai klausimai.\nKontaktai: **+370 648 803 88**, **info@batutynas.lt**\n\n## Formato taisyklÄ—s\n\n- Trumpi atsakymai: 1-3 pastraipos\n- Naudok **bold** svarbiai informacijai\n- **NERAÅ YK** \"Ar turite daugiau klausimÅ³?\" â€” sistema automatiÅ¡kai prideda mygtukus.\n\nThe customer's browser language is: {{ $json.browserLang }}\nCustomer email (if known): {{ $json.userEmail }}\nCustomer name (if known): {{ $json.userName }}"
        },
        "promptType": "define",
        "text": "={{ $('Extract & Route').item.json.chatInput }}"
      },
      "id": "fb-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        1320,
        700
      ]
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-preview-04-17",
        "options": {
          "maxOutputTokens": 1024,
          "temperature": 0.3
        }
      },
      "id": "fb-llm-gemini",
      "name": "Gemini 2.5 Flash",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1220,
        920
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "GOOGLE_AI_CRED_ID",
          "name": "Google AI (PaLM/Gemini)"
        }
      }
    },
    {
      "parameters": {
        "sessionKey": "={{ $('Extract & Route').item.json.sessionId }}",
        "contextWindowLength": 16
      },
      "id": "fb-memory",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1320,
        920
      ]
    },
    {
      "parameters": {
        "name": "booking_notify",
        "description": "Send a booking inquiry notification to the admin. Use this tool when a customer has provided all booking details: date, location, event_type, contact_name, contact_phone, and optionally trampoline_preference. Input should include all collected fields as a JSON string.",
        "workflowId": "PASTE_YOUR_BOOKING_WORKFLOW_ID_HERE",
        "responsePropertyName": "result",
        "fields": {
          "values": [
            {
              "name": "booking_data",
              "stringValue": "{booking_data}"
            }
          ]
        }
      },
      "id": "fb-tool-booking",
      "name": "Tool: Booking Notify",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        1420,
        920
      ]
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $input.first().json || {};\nconst senderId = $('Extract & Route').item.json.senderId;\nlet response = agentOutput.output || agentOutput.text || '';\n\nif (!response || !response.trim()) {\n  response = 'AtsipraÅ¡ome, Å¡iuo metu negaliu atsakyti. Susisiekite tiesiogiai: +370 648 803 88 arba info@batutynas.lt';\n}\n\n// --- Equipment data (categorized by use-case groups) ---\nconst TRAMPOLINES = [\n  // --- big-park (for public events only) ---\n  { name: 'DÅ¾iumandÅ¾i parkas', type: 'NuotykiÅ³ parkas Â· 14x16 m', capacity: 'Iki 40 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2026-01-19-at-08.02.18-Rc7QdQX9UPx5Qii4.jpeg', min: 15, max: 40, cat: 'big-park' },\n  { name: 'FantazijÅ³ parkas', type: 'BatutÅ³ parkas Â· 14x14 m', capacity: 'Iki 30 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/dji_fly_20250718_183358_615_1752852849151_photo_optimized-1-Su0yn2ubUUAdRTaM.jpg', min: 10, max: 30, cat: 'big-park' },\n  { name: 'Giga ruoÅ¾as', type: 'KliÅ«ÄiÅ³ trasa 40 m Â· 45x8 m', capacity: '360 dalyviÅ³/val.', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/klia-aia3-ruoa3-4as7_-PF5s1CBJOSf9Dsw8.jpg', min: 10, max: 100, cat: 'big-park' },\n\n  // --- mega-trampoline (for birthdays + public) ---\n  { name: 'Mega Waikiki', type: 'AukÅ¡Äiausias 8,5 m Â· 16x4 m', capacity: 'Iki 15 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2026-01-19-at-08.02.20-1-qKrIjl8vIiaDDEeJ.jpeg', min: 5, max: 15, cat: 'mega-trampoline' },\n  { name: 'Mega Rocket', type: '2 daliÅ³ batutas Â· 14x5 m', capacity: 'Iki 15 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/dji_fly_20250608_144102_598_1749383165455_photo-1-DWXubfRscVaZs0KU.jpg', min: 5, max: 15, cat: 'mega-trampoline' },\n  { name: 'Mega Ufonautai', type: '2 daliÅ³ batutas Â· 14x5 m', capacity: 'Iki 15 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2025-03-21-at-15.48.00-k77GausjdJtLgsxH.jpeg', min: 5, max: 15, cat: 'mega-trampoline' },\n  { name: 'Mega ruoÅ¾as', type: 'KliÅ«ÄiÅ³ trasa 21 m Â· 25x6 m', capacity: '240 dalyviÅ³/val.', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/klia-aia3-ruoa3-4as5_-xMAasSCrKpRl9Lza.jpg', min: 8, max: 100, cat: 'mega-trampoline' },\n\n  // --- standard-trampoline (for birthdays) ---\n  { name: 'Monstrai', type: 'Su Dart Å¾aidimu Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210165240_881_49-sRgMsjrVMtThU9QZ.png', min: 4, max: 12, cat: 'standard-trampoline' },\n  { name: 'Candy Pop', type: 'Spalvingas Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210165543_886_49-6FZ64pJgz45vxYSk.png', min: 4, max: 12, cat: 'standard-trampoline' },\n  { name: 'AÅ¡tuonkojis', type: 'JÅ«ros tema Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210164945_873_49-guBAxfjAKUTQkefw.png', min: 4, max: 12, cat: 'standard-trampoline' },\n  { name: 'Chameleonas', type: 'Su ÄiuoÅ¾ykla Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210165904_889_49-YAzOnlljvGg8uSaZ.png', min: 4, max: 12, cat: 'standard-trampoline' },\n  { name: 'Vienaragiai', type: 'Su tuneliais Â· 9x4 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/vienaragiai_live1-WinCFPxPLvD4Bvpp.jpg', min: 4, max: 12, cat: 'standard-trampoline' },\n  { name: 'Pilis maÅ¾iesiems', type: 'Iki 5 metÅ³ Â· 5x4 m', capacity: 'Iki 6 vaikÅ³', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/dji_fly_20250525_115950_542_1748163603293_photo_optimized-Vr2HXTPMFyM6szXt.jpg', min: 2, max: 6, cat: 'standard-trampoline' },\n\n  // --- addon (extras for any event) ---\n  { name: 'MilÅ¾iniÅ¡kas Dart', type: 'Interaktyvi pramoga Â· 5x4,5 m', capacity: '60 dalyviÅ³/val.', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/img-20250825-wa0000-1-KNKOwGZxrP8Qotu0.jpg', min: 1, max: 999, cat: 'addon' },\n  { name: 'KamuoliÅ³ medÅ¾ioklÄ—', type: 'Komandinis Å¾aidimas Â· 8 m arena', capacity: '4 Å¾aidÄ—jai/raundas', price: 'pagal uÅ¾klausÄ…', img: '', min: 1, max: 999, cat: 'addon' },\n  { name: 'Rodeo bulius', type: 'Mechaninis bulius Â· 5x5 m', capacity: 'Neribota', price: 'pagal uÅ¾klausÄ…', img: '', min: 1, max: 999, cat: 'addon' },\n  { name: 'SaldÄ—siÅ³ aparatai', type: '1 NEMOKAMAI su batutu', capacity: 'Vata, popcorn, Å¡erbetas', price: 'pagal uÅ¾klausÄ…', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/unnamed-2-DZswbmOPQZ24Gc8b.jpg', min: 1, max: 999, cat: 'addon' },\n\n  // --- party-equipment (party group only) ---\n  { name: 'Disco paviljonas', type: 'LED apÅ¡vietimas Â· 4x4 m', capacity: 'Iki 20 Å¾moniÅ³', price: 'pagal uÅ¾klausÄ…', img: '', min: 1, max: 999, cat: 'party-equipment' },\n  { name: 'PutÅ³ Å¡ou', type: 'PutÅ³ maÅ¡ina + baseinas', capacity: 'Neribota', price: 'pagal uÅ¾klausÄ…', img: '', min: 1, max: 999, cat: 'party-equipment' },\n  { name: 'Banketo stalai ir kÄ—dÄ—s', type: 'Stalai + kÄ—dÄ—s komplektas', capacity: 'Iki 50 vietÅ³', price: 'pagal uÅ¾klausÄ…', img: '', min: 1, max: 999, cat: 'party-equipment' }\n];\n\n// Default placeholder for items without images\nconst DEFAULT_IMG = 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=600,h=400,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2026-01-19-at-08.02.18-Rc7QdQX9UPx5Qii4.jpeg';\n\n// --- Build carousel from filtered items (max 10 per carousel) ---\nfunction buildCarousels(items) {\n  const msgs = [];\n  const chunks = [];\n  for (let i = 0; i < items.length; i += 10) {\n    chunks.push(items.slice(i, i + 10));\n  }\n  for (const chunk of chunks) {\n    const elements = chunk.map(t => ({\n      title: t.name,\n      subtitle: t.type + ' Â· ' + t.capacity,\n      image_url: t.img || DEFAULT_IMG,\n      buttons: [{ type: 'postback', title: 'Pasirinkti âœ“', payload: t.name }]\n    }));\n    msgs.push({\n      recipient: { id: senderId },\n      messaging_type: 'RESPONSE',\n      message: { attachment: { type: 'template', payload: { template_type: 'generic', elements } } }\n    });\n  }\n  return msgs;\n}\n\n// --- Build main menu quick replies ---\nfunction buildMainMenuQuickReplies() {\n  return [\n    { content_type: 'text', title: 'ğŸ‚ Gimtadienis', payload: 'Planuoju vaikÅ³ gimtadienÄ¯ arba krikÅ¡tynas' },\n    { content_type: 'text', title: 'ğŸª VieÅ¡as renginys', payload: 'Planuoju vieÅ¡Ä… renginÄ¯ arba Ä¯monÄ—s sÄ…skrydÄ¯' },\n    { content_type: 'text', title: 'ğŸ‰ VakarÄ—lis', payload: 'Planuoju triukÅ¡mingÄ… vakarÄ—lÄ¯' },\n    { content_type: 'text', title: 'ğŸ›’ Pirkti batutÄ…', payload: 'Noriu pirkti batutÄ…' },\n    { content_type: 'text', title: 'â„¹ï¸ Info / DUK', payload: 'Saugumas, DUK ir kontaktai' }\n  ];\n}\n\n// --- Build date quick replies ---\nfunction buildDateQuickReplies() {\n  const days = [];\n  const now = new Date();\n  const d = new Date(now);\n  d.setDate(d.getDate() + ((6 - d.getDay() + 7) % 7 || 7));\n  for (let i = 0; i < 4; i++) {\n    const iso = d.toISOString().split('T')[0];\n    const label = d.toLocaleDateString('lt-LT', { month: 'short', day: 'numeric', weekday: 'short' });\n    days.push({ content_type: 'text', title: label.substring(0, 20), payload: iso });\n    d.setDate(d.getDate() + 7);\n  }\n  days.push({ content_type: 'text', title: 'Kita data âœï¸', payload: 'CUSTOM_DATE' });\n  return days;\n}\n\n// --- Build location quick replies ---\nfunction buildLocationQuickReplies() {\n  const locs = ['TauragÄ—', 'Å ilalÄ—', 'Jurbarkas', 'PagÄ—giai', 'Raseiniai', 'KelmÄ—', 'Rietavas', 'Kitas miestas'];\n  return locs.map(loc => ({ content_type: 'text', title: loc.substring(0, 20), payload: loc }));\n}\n\n// --- Build guest count quick replies ---\nfunction buildGuestCountQuickReplies() {\n  return [\n    { content_type: 'text', title: 'Iki 6 vaikÅ³', payload: 'Apie 6 sveÄiÅ³' },\n    { content_type: 'text', title: '7â€“12 vaikÅ³', payload: 'Apie 10 sveÄiÅ³' },\n    { content_type: 'text', title: '13â€“20 vaikÅ³', payload: 'Apie 15 sveÄiÅ³' },\n    { content_type: 'text', title: 'Daugiau nei 20', payload: 'Apie 30 sveÄiÅ³' }\n  ];\n}\n\n// --- Build purchase submenu quick replies ---\nfunction buildPurchaseQuickReplies() {\n  return [\n    { content_type: 'text', title: 'ğŸ“§ Katalogas el. paÅ¡tu', payload: 'Noriu gauti batutÅ³ katalogÄ… el. paÅ¡tu' },\n    { content_type: 'text', title: 'ğŸ¨ Individuali gamyba', payload: 'Noriu individualios batuto gamybos' }\n  ];\n}\n\n// --- Build booking confirmation text ---\nfunction buildBookingConfirm(jsonStr) {\n  let data;\n  try { data = JSON.parse(jsonStr); } catch { data = {}; }\n  let text = 'âœ… UÅ¾klausa pateikta!\\n\\n';\n  if (data.group_type) text += 'Tipas: ' + data.group_type + '\\n';\n  if (data.date) text += 'ğŸ“… Data: ' + data.date + '\\n';\n  if (data.location) text += 'ğŸ“ Vieta: ' + data.location + '\\n';\n  if (data.event_type) text += 'ğŸ‰ Renginys: ' + data.event_type + '\\n';\n  if (data.guest_count) text += 'ğŸ‘¥ SveÄiÅ³: ' + data.guest_count + '\\n';\n  if (data.contact_name) text += 'ğŸ‘¤ Kontaktas: ' + data.contact_name + '\\n';\n  if (data.contact_phone) text += 'ğŸ“ Telefonas: ' + data.contact_phone + '\\n';\n  if (data.trampoline) text += 'ğŸª Batutas: ' + data.trampoline + '\\n';\n  if (data.dimensions) text += 'ğŸ“ Matmenys: ' + data.dimensions + '\\n';\n  if (data.colors) text += 'ğŸ¨ Spalvos: ' + data.colors + '\\n';\n  if (data.characters) text += 'ğŸ§¸ PersonaÅ¾ai: ' + data.characters + '\\n';\n  if (data.email) text += 'ğŸ“§ El. paÅ¡tas: ' + data.email + '\\n';\n  return text;\n}\n\n// --- Group-specific equipment builders ---\nfunction getBirthdayItems(guestCount) {\n  const standard = TRAMPOLINES.filter(t => t.cat === 'standard-trampoline');\n  const mega = TRAMPOLINES.filter(t => t.cat === 'mega-trampoline');\n  let items = standard.concat(mega);\n  if (guestCount) {\n    // Sort recommended first\n    const rec = items.filter(t => t.min <= guestCount && guestCount <= t.max);\n    const other = items.filter(t => !(t.min <= guestCount && guestCount <= t.max));\n    items = rec.concat(other);\n  }\n  return items;\n}\n\nfunction getPublicItems(guestCount) {\n  const bigParks = TRAMPOLINES.filter(t => t.cat === 'big-park');\n  const mega = TRAMPOLINES.filter(t => t.cat === 'mega-trampoline');\n  const standard = TRAMPOLINES.filter(t => t.cat === 'standard-trampoline');\n  let items = bigParks.concat(mega).concat(standard);\n  if (guestCount) {\n    const rec = items.filter(t => t.min <= guestCount && guestCount <= t.max);\n    const other = items.filter(t => !(t.min <= guestCount && guestCount <= t.max));\n    items = rec.concat(other);\n  }\n  return items;\n}\n\nfunction getPartyItems() {\n  return TRAMPOLINES.filter(t => t.cat === 'party-equipment');\n}\n\n// --- Process markers in response ---\nconst messages = [];\nlet remaining = response;\n\n// Helper to push text message\nfunction pushText(text, quickReplies) {\n  if (!text || !text.trim()) return;\n  let plainText = text.replace(/\\*\\*(.+?)\\*\\*/g, '$1').trim();\n  if (plainText.length > 2000) plainText = plainText.substring(0, 1997) + '...';\n  const msg = { recipient: { id: senderId }, messaging_type: 'RESPONSE', message: { text: plainText } };\n  if (quickReplies) msg.message.quick_replies = quickReplies;\n  messages.push(msg);\n}\n\n// Check for booking confirm first (has capture group)\nconst confirmMatch = remaining.match(/\\[BOOKING_CONFIRM:(\\{[^\\]]*\\})\\]/);\nif (confirmMatch) {\n  const beforeConfirm = remaining.substring(0, confirmMatch.index).trim();\n  const afterConfirm = remaining.substring(confirmMatch.index + confirmMatch[0].length).trim();\n  if (beforeConfirm) pushText(beforeConfirm);\n  pushText(buildBookingConfirm(confirmMatch[1]));\n  if (afterConfirm) pushText(afterConfirm);\n  remaining = '';\n}\n\n// Marker handlers\nconst markerDefs = [\n  { pattern: /\\[MAIN_MENU\\]/, qr: () => buildMainMenuQuickReplies(), fallback: 'Pasirinkite kategorijÄ… ğŸ‘‡' },\n  { pattern: /\\[DATE_PICKER\\]/, qr: () => buildDateQuickReplies(), fallback: 'Pasirinkite datÄ… ğŸ‘‡' },\n  { pattern: /\\[LOCATION_OPTIONS\\]/, qr: () => buildLocationQuickReplies(), fallback: 'Kur vyks renginys?' },\n  { pattern: /\\[GUEST_COUNT\\]/, qr: () => buildGuestCountQuickReplies(), fallback: 'Kiek sveÄiÅ³ planuojate?' },\n  { pattern: /\\[PURCHASE_SUBMENU\\]/, qr: () => buildPurchaseQuickReplies(), fallback: 'KÄ… norÄ—tumÄ—te?' },\n  { pattern: /\\[PURCHASE_EMAIL_INPUT\\]/, qr: null, fallback: null, textReplace: 'ParaÅ¡ykite savo el. paÅ¡to adresÄ… ir atsiÅ³sime batutÅ³ katalogÄ… ğŸ“§' },\n  { pattern: /\\[PURCHASE_CUSTOM_FORM\\]/, qr: null, fallback: null, textReplace: 'ApraÅ¡ykite savo pageidavimus:\\n1. Pageidaujami matmenys (plotis x ilgis x aukÅ¡tis)\\n2. Spalvos\\n3. PersonaÅ¾ai / tema\\n4. Papildomi pageidavimai\\n5. Kontaktinis el. paÅ¡tas\\n6. Telefono numeris' }\n];\n\n// Group equipment markers (with optional guest count)\nconst groupMarkers = [\n  { pattern: /\\[MENU_GROUP_BIRTHDAY(?::(\\d+))?\\]/, items: (count) => getBirthdayItems(count) },\n  { pattern: /\\[MENU_GROUP_PUBLIC(?::(\\d+))?\\]/, items: (count) => getPublicItems(count) },\n  { pattern: /\\[MENU_GROUP_PARTY\\]/, items: () => getPartyItems() }\n];\n\nif (remaining) {\n  let found = false;\n\n  // Check group equipment markers first (they produce carousels)\n  for (const gm of groupMarkers) {\n    const match = remaining.match(gm.pattern);\n    if (match) {\n      const textBefore = remaining.substring(0, match.index).trim();\n      const textAfter = remaining.substring(match.index + match[0].length).trim();\n      const count = match[1] ? parseInt(match[1]) : null;\n      if (textBefore) pushText(textBefore);\n      const items = gm.items(count);\n      const carousels = buildCarousels(items);\n      messages.push(...carousels);\n      if (textAfter) {\n        const cleaned = textAfter.replace(/\\[MENU_GROUP_BIRTHDAY(?::\\d+)?\\]/g, '').replace(/\\[MENU_GROUP_PUBLIC(?::\\d+)?\\]/g, '').replace(/\\[MENU_GROUP_PARTY\\]/g, '').trim();\n        if (cleaned) pushText(cleaned);\n      }\n      found = true;\n      break;\n    }\n  }\n\n  // Check quick-reply markers\n  if (!found) {\n    for (const md of markerDefs) {\n      const match = remaining.match(md.pattern);\n      if (match) {\n        const textBefore = remaining.substring(0, match.index).trim();\n        const textAfter = remaining.substring(match.index + match[0].length).trim();\n\n        if (md.textReplace) {\n          if (textBefore) pushText(textBefore);\n          pushText(md.textReplace);\n        } else if (md.qr) {\n          const promptText = textBefore || md.fallback;\n          pushText(promptText, md.qr());\n        }\n\n        if (textAfter) {\n          // Strip remaining markers\n          const cleaned = textAfter\n            .replace(/\\[MAIN_MENU\\]/g, '').replace(/\\[DATE_PICKER\\]/g, '').replace(/\\[LOCATION_OPTIONS\\]/g, '')\n            .replace(/\\[GUEST_COUNT\\]/g, '').replace(/\\[PURCHASE_SUBMENU\\]/g, '').replace(/\\[PURCHASE_EMAIL_INPUT\\]/g, '')\n            .replace(/\\[PURCHASE_CUSTOM_FORM\\]/g, '').replace(/\\[BOOKING_CONFIRM:\\{[^\\]]*\\}\\]/g, '')\n            .replace(/\\[MENU_GROUP_BIRTHDAY(?::\\d+)?\\]/g, '').replace(/\\[MENU_GROUP_PUBLIC(?::\\d+)?\\]/g, '')\n            .replace(/\\[MENU_GROUP_PARTY\\]/g, '').trim();\n          if (cleaned) pushText(cleaned);\n        }\n        found = true;\n        break;\n      }\n    }\n  }\n\n  // No markers â€” plain text\n  if (!found) {\n    pushText(remaining);\n  }\n}\n\n// Fallback\nif (messages.length === 0) {\n  pushText('AtsipraÅ¡ome, Å¡iuo metu negaliu atsakyti. Susisiekite: +370 648 803 88');\n}\n\nreturn [{ json: { messages } }];\n"
      },
      "id": "fb-format",
      "name": "Format for Messenger",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        700
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst messages = input.messages || [];\nconst accessToken = \"PASTE_YOUR_FB_PAGE_ACCESS_TOKEN_HERE\";\n\nif (accessToken === \"PASTE_YOUR_FB_PAGE_ACCESS_TOKEN_HERE\") {\n  throw new Error('FB Page Access Token not configured. Replace the placeholder in Send to Messenger node.');\n}\n\nconst results = [];\n\nfor (let i = 0; i < messages.length; i++) {\n  const msg = messages[i];\n\n  try {\n    const response = await fetch(\n      'https://graph.facebook.com/v21.0/me/messages',\n      {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer ' + accessToken\n        },\n        body: JSON.stringify(msg)\n      }\n    );\n\n    const data = await response.json();\n\n    if (!response.ok) {\n      console.error('FB API error: ' + response.status + ' ' + JSON.stringify(data));\n    }\n\n    results.push({ success: response.ok, status: response.status, data });\n\n    // Small delay between messages to maintain order\n    if (i < messages.length - 1) {\n      await new Promise(resolve => setTimeout(resolve, 300));\n    }\n  } catch (error) {\n    console.error('FB API fetch error: ' + error.message);\n    results.push({ success: false, error: error.message });\n  }\n}\n\nreturn [{ json: { sent: results.length, results } }];"
      },
      "id": "fb-send",
      "name": "Send to Messenger",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-process",
              "leftValue": "={{ $('Extract & Route').item.json.routeType }}",
              "rightValue": "ignore",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fb-should-process",
      "name": "Should Process?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        990,
        400
      ]
    }
  ],
  "connections": {
    "FB Webhook": {
      "main": [
        [
          {
            "node": "Extract & Route",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract & Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract & Route": {
      "main": [
        [
          {
            "node": "Is Verification?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Verification?": {
      "main": [
        [
          {
            "node": "Respond with Challenge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond 200 OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond 200 OK": {
      "main": [
        [
          {
            "node": "Should Process?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Process?": {
      "main": [
        [
          {
            "node": "Is Get Started?",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Is Get Started?": {
      "main": [
        [
          {
            "node": "Welcome Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Unsupported?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Welcome Message": {
      "main": [
        [
          {
            "node": "Send to Messenger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Unsupported?": {
      "main": [
        [
          {
            "node": "Unsupported Reply",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unsupported Reply": {
      "main": [
        [
          {
            "node": "Send to Messenger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Tool: Booking Notify": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format for Messenger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format for Messenger": {
      "main": [
        [
          {
            "node": "Send to Messenger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.5 Flash": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Batutynas Chat",
      "id": "batutynas-chat"
    }
  ],
  "triggerCount": 0,
  "versionId": "1"
}