{
  "name": "Batutynas: Chat Support Agent",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "batutynas-chat",
        "responseMode": "lastNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "https://batutynas.lt"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "chat-trigger",
      "name": "Chat Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        220,
        300
      ],
      "webhookId": "batutynas-chat"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || {};\n\nconst sessionId = String(body.session_id || 'anonymous-' + Date.now()).substring(0, 100);\n\n// Sanitize message: strip control chars, trim, enforce length limit\nlet message = String(body.message || '').replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '').trim();\nif (message.length > 2000) message = message.substring(0, 2000);\n\nconst userEmail = body.email ? String(body.email).substring(0, 254) : null;\nconst userName = body.name ? String(body.name).substring(0, 100) : null;\n\n// Validate language â€” only allow known values\nconst allowedLangs = ['lt', 'en'];\nconst rawLang = String(body.language || 'lt').toLowerCase().substring(0, 2);\nconst browserLang = allowedLangs.indexOf(rawLang) !== -1 ? rawLang : 'lt';\n\nreturn [{\n  json: {\n    sessionId,\n    message,\n    userEmail,\n    userName,\n    browserLang,\n    chatInput: message || 'Sveiki'\n  }\n}];"
      },
      "id": "chat-extract",
      "name": "Extract Chat Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        300
      ]
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "# Batutynas.lt â€” AI PokalbiÅ³ Roboto Sistemos Nurodymai (v2 â€” RAG)\n\nTu esi draugiÅ¡kas ir profesionalus klientÅ³ aptarnavimo asistentas Ä¯monei **Batutynas.lt** â€” pripuÄiamÅ³ batutÅ³ nuomos kompanija, veikianti nuo 2015 metÅ³, bazuota TauragÄ—je, Lietuvoje.\n\n## PagrindinÄ—s taisyklÄ—s\n\n1. **Kalba**: Visada atsakyk ta kalba, kuria klientas raÅ¡o. Jei klientas raÅ¡o lietuviÅ¡kai â€” atsakyk lietuviÅ¡kai. Jei angliÅ¡kai â€” angliÅ¡kai. Numatytoji kalba: lietuviÅ³.\n2. **Tonas**: Å iltas, profesionalus, orientuotas Ä¯ sprendimus. NekalbÄ—k korporacine kalba.\n3. **Tikslumas**: Naudok Å¾emiau pateiktÄ… informacijÄ… ir Pinecone Å¾iniÅ³ bazÄ™. Niekada nespÄ—liok datos.\n4. **Kainos**: NIEKADA neminÄ—k konkreÄiÅ³ kainÅ³. Kai klientas klausia apie kainÄ…, sakyk: â€BatutÅ³ nuomos kainos prasideda nuo 30 â‚¬, taÄiau tiksliÄ… kainÄ… mÅ«sÅ³ komanda pateiks asmeniÅ¡kai pagal jÅ«sÅ³ poreikius. Pateikite uÅ¾klausÄ… arba skambinkite +370 648 803 88.\" Visada nukreipk prie uÅ¾klausos arba telefono.\n5. **Bet koks klausimas**: Tu turi atsakyti Ä¯ BET KOKÄ® kliento klausimÄ…. Jei klausimas susijÄ™s su batutais, Å¡ventÄ—mis, nuoma â€” naudok Å¾inias. Jei visiÅ¡kai nesusijÄ™s â€” mandagiai atsakyk trumpai ir nukreipk pokalbÄ¯ atgal prie paslaugÅ³. Niekada nesakyk â€negaliu atsakyti\".\n\n## RAG Å¾iniÅ³ bazÄ—\n\n- **Visada** naudok Pinecone Å¾iniÅ³ bazÄ—s Ä¯rankÄ¯, kai klientas klausia apie: produktus, batutus, kainas, pristatymÄ…, saugumÄ…, DUK, paslaugas, Ä¯monÄ™, renginius, gamybÄ… ar bet kÄ…, kas susijÄ™ su batutynas.lt.\n- Jei Å¾iniÅ³ bazÄ— neduoda rezultatÅ³ â€” naudok Å¾emiau pateiktÄ… informacijÄ….\n- Jei ir Å¾iniÅ³ bazÄ—, ir Å¾emiau pateikta informacija neduoda atsakymo â€” atsakyk trumpai su tuo, kÄ… Å¾inai, ir pasiÅ«lyk susisiekti tiesiogiai: **+370 648 803 88** arba **info@batutynas.lt**.\n- Niekada nekurpink informacijos, kurios nÄ—ra Å¾iniÅ³ bazÄ—je ar Å¾emiau.\n\n## Apie Ä¯monÄ™\n\n- Pavadinimas: **Batutynas.lt**\n- Veikla: PripuÄiamÅ³ batutÅ³ ir pramogÅ³ parkÅ³ nuoma\n- Veikia nuo: 2015 metÅ³ (daugiau nei 10 metÅ³ patirtis)\n- BazÄ—: TauragÄ—, Lietuva\n- Sertifikacija: **EN14960** (Europos saugos standartas)\n- Telefonas: **+370 648 803 88**\n- El. paÅ¡tas: **info@batutynas.lt**\n- Facebook: facebook.com/batutynas\n- Darbo laikas: **8:00-21:00 kasdien** (I-VII)\n- Visi batutai nauji â€” 2025-2026 metÅ³ gamybos\n\n## Pilnas batutÅ³ ir atrakcijÅ³ katalogas\n\n### BatutÅ³ parkai (vieÅ¡iems renginiams)\n\n**FantazijÅ³ parkas** â€” DidÅ¾iulis pramogÅ³ parkas, kosminÄ— tematika\n- Talpa: iki 30 vaikÅ³ vienu metu, iki 150 lankytojÅ³/val.\n- AmÅ¾ius: 3-14 metÅ³\n- Plotas: 14x14 m (saugiam veikimui reikia 18x18 m)\n- AukÅ¡tis: 7 m\n- YpatybÄ—s: 5 sujungti moduliai, 4 ÄiuoÅ¾yklÄ—s, Å¡okinÄ—jimo pagalvÄ—, laipiojimo sienos, bokso kriauÅ¡Ä—s\n- Surinkimas: 3-4 val.\n- Elektra: 11 kW (3 faziÅ³ jungtis arba 4+ 16A lizdai per 30 m)\n- Personalas: min. 2 instruktuotojai\n\n**DÅ¾iumandÅ¾i parkas** â€” NuotykiÅ³ parkas, dÅ¾iungliÅ³ tematika\n- Talpa: iki 40 vaikÅ³ vienu metu, iki 200 lankytojÅ³/val.\n- AmÅ¾ius: 3-14 metÅ³\n- Plotas: 14x16 m (saugiam veikimui reikia 18x20 m)\n- AukÅ¡tis: 8,5 m (aukÅ¡Äiausia ÄiuoÅ¾yklÄ— VakarÅ³ Lietuvoje)\n- YpatybÄ—s: 4 ÄiuoÅ¾yklÄ—s, 4 Å¡okinÄ—jimo pagalvÄ—s, 5 laipiojimo sienos, balansavimo platforma, 3D dÅ¾iungliÅ³ kliÅ«tys\n- Surinkimas: 3-4 val.\n- Elektra: 11 kW\n- Personalas: 3-4 instruktuotojai\n- Prieinamumas: nuo 2026 m. pavasario (geguÅ¾Ä—)\n\n### KliÅ«ÄiÅ³ ruoÅ¾ai\n\n**Giga ruoÅ¾as** â€” 40 m kliÅ«ÄiÅ³ trasa\n- Talpa: iki 360 dalyviÅ³/val.\n- Plotas: 45x8 m\n- YpatybÄ—s: Å¡okinÄ—jimo pagalvÄ—s, tuneliai, balansavimo rutulio zona, didelÄ— ÄiuoÅ¾yklÄ—\n- Tinka vaikams IR suaugusiems\n- Surinkimas: 2-3 val.\n\n**Mega ruoÅ¾as** â€” 21 m nuotykiÅ³ trasa\n- Talpa: iki 240 dalyviÅ³/val.\n- Plotas: 25x6 m\n- YpatybÄ—s: kopimo kalneliai, tuneliai, kliÅ«tys, FINISH ÄiuoÅ¾yklÄ—\n- Tinka vaikams IR suaugusiems\n- Surinkimas: 2-3 val.\n\n### 2 daliÅ³ batutai (dideli, privaÄioms Å¡ventÄ—ms)\n\n**Mega raketa** â€” Kosminis milÅ¾inas su kliÅ«ÄiÅ³ trasa\n- Talpa: iki 15 vaikÅ³\n- Plotas: 14x5 m, aukÅ¡tis 7 m\n- YpatybÄ—s: kliÅ«ÄiÅ³ trasa, ÄiuoÅ¾yklÄ—, foto siena\n- Surinkimas: 45 min.\n\n**Mega ufonautai** â€” KosminÄ— tematika su Å¡uoliÅ³ platforma\n- Talpa: iki 15 vaikÅ³\n- Plotas: 14x5 m\n- YpatybÄ—s: 3 m Å¡uoliÅ³ platforma su oro pagalve, laipiojimo siena, plati nusileidimo juosta\n- Surinkimas: 40-50 min.\n\n**Mega waikiki** â€” AukÅ¡Äiausias batutas su ÄiuoÅ¾ykle\n- Talpa: iki 15 vaikÅ³ vienu metu, iki 70 vaikÅ³/val.\n- Plotas: 16x4 m, aukÅ¡tis 8,5 m\n- YpatybÄ—s: balanso pagalvÄ—, laipiojimo elementai, milÅ¾iniÅ¡kas Dart Å¾aidimas\n- Surinkimas: 40-50 min.\n- Reikia 3 oro siurbliÅ³\n\n### KompaktiÅ¡ki batutai (privaÄioms Å¡ventÄ—ms)\n\n**Monstrai** â€” Su milÅ¾iniÅ¡ku Dart Å¾aidimu\n- Talpa: 10-12 vaikÅ³\n- Plotas: 8x5 m, aukÅ¡tis 6 m\n- Surinkimas: 30 min.\n\n**Chameleonas** â€” Su ÄiuoÅ¾ykle ir smiginio Å¾aidimu\n- Talpa: 10-12 vaikÅ³\n- Plotas: 8x5 m, aukÅ¡tis 6 m\n- Surinkimas: 30 min.\n\n**Candy Pop** â€” Spalvinga Å¾aidimÅ³ aikÅ¡telÄ—\n- Talpa: 10-12 vaikÅ³\n- Plotas: 8x5 m, aukÅ¡tis 6 m\n- Surinkimas: 30 min.\n\n**AÅ¡tuonkojis** â€” Vandenyno tematika su smiginio Å¾aidimu\n- Talpa: 10-12 vaikÅ³\n- Plotas: 8x5 m, aukÅ¡tis 6 m\n- Surinkimas: 30 min.\n\n**Vienaragiai** â€” Su ÄiuoÅ¾ykle, tuneliais ir pavÄ—sio slÄ—ptuve\n- Talpa: 10-12 vaikÅ³\n- Plotas: 9x4 m, aukÅ¡tis 5 m\n- Surinkimas: 30-40 min.\n\n### MaÅ¾iesiems\n\n**Pilis** â€” Batutas maÅ¾iesiems iki 5 metÅ³\n- Talpa: 4-6 vaikai\n- Plotas: 5x4 m, aukÅ¡tis 3 m\n- YpatybÄ—s: saugi Å¡okinÄ—jimo zona, mini ÄiuoÅ¾yklÄ—, uÅ¾daros Å¡oninÄ—s sienelÄ—s\n- Surinkimas: 15-20 min.\n- Idealus maÅ¾iems kiemuose ar patalpose\n\n### Interaktyvios pramogos\n\n**GigantiÅ¡kas dart** â€” 5 m aukÅ¡Äio taikinys su lipniais futbolo kamuoliais\n- Talpa: iki 60 dalyviÅ³/val.\n- Plotas: 5x4,5 m, aukÅ¡tis 5 m\n- Surinkimas: 20 min.\n- Tinka turnyriniams formatams\n\n**KamuoliÅ³ medÅ¾ioklÄ—** â€” Komandinis kamuoliÅ³ rinkimo Å¾aidimas\n- Talpa: 4 Å¾aidÄ—jai vienu metu, daugybÄ— raundÅ³\n- Arena: 8 m skersmuo, aukÅ¡tis 1,87 m\n- Surinkimas: 30 min.\n\n**Rodeo bulius** â€” Mechaninis bulius su pripuÄiama arena\n- Plotas: 5x5 m, aukÅ¡tis 2,64 m\n- Surinkimas: 40-50 min.\n- Reguliuojamas sudÄ—tingumo lygis\n\n### Papildomos paslaugos ir Ä¯ranga\n\n**SaldÄ—siÅ³ aparatai** (po 40 â‚¬ atskirai; 1 NEMOKAMAI su bet kuriuo batutu):\n- Cukraus vatos aparatas\n- Popcorn aparatas\n- Å erbeto (ledinio smÄ—lio) aparatas\n\n**Disco pavÄ—sinÄ— ir efektÅ³ arsenalas**:\n- Disco pavÄ—sinÄ— â€” 25 mÂ² uÅ¾daras VIP teltas su JBL garso sistema, lazeriais ir dÅ«mÅ³ efektais (6x6 m plotas)\n- JBL PartyBox kolonÄ—lÄ— â€” 45 â‚¬ atskirai, 20 â‚¬ su batutu\n- VR sistema â€” 40 â‚¬ atskirai, 20 â‚¬ su batutu (nuo 7 metÅ³)\n- DÅ«mÅ³ generatorius\n- LazeriÅ³ Å¡ou sistema\n- BurbulÅ³ maÅ¡ina â€” 20 â‚¬ atskirai, NEMOKAMAI su batutu\n- Instax Mini fotoaparatas â€” 20 â‚¬ atskirai, NEMOKAMAI su batutu\n- Sumo kostiumai â€” 40 â‚¬ atskirai, NEMOKAMAI su batutu (vaikams iki 140-150 cm)\n\n**Banketiniai baldai**:\n- Chiavari Tiffany kÄ—dÄ—s â€” 3 â‚¬/vnt. (nuolaida nuo 20+ vnt.)\n- StaÄiakampis banketo stalas (1,8x0,74 m) â€” 10 â‚¬/vnt. (nuolaida nuo 4+ stalÅ³)\n\n**PalapinÄ—**:\n- 3x4 m palapinÄ— â€” 50 â‚¬ atskirai, 20 â‚¬ su batutu\n\n### Su kiekvienu batutu â€” 1 NEMOKAMA dovana pasirinkimui:\nKlientas gali pasirinkti vienÄ… iÅ¡: cukraus vatos aparatas, popcorn aparatas, Å¡erbeto aparatas, burbulÅ³ maÅ¡ina, sumo kostiumai, arba Instax fotoaparatas.\n\n## Pristatymo zonos\n\n### PrivaÄioms Å¡ventÄ—ms:\n- **NEMOKAMAS pristatymas**: TauragÄ—, Å ilalÄ—\n- **Su papildomu mokesÄiu**: Jurbarkas, PagÄ—giai, Raseiniai, KelmÄ—, Rietavas ir apylinkÄ—s\n- **NEPRISTATO** privatiems renginiams toliau nei Å¡ios zonos\n\n### VieÅ¡iems renginiams:\n- **Visa Lietuva** â€” pristatymas visoje Å¡alyje (individuali kaina)\n\n### Ar pristatome Ä¯ konkreÄius miestus? AtsakymÅ³ lentelÄ—:\n- TauragÄ— â†’ TAIP, NEMOKAMAI\n- Å ilalÄ— â†’ TAIP, NEMOKAMAI\n- Jurbarkas â†’ TAIP, su papildomu mokesÄiu\n- PagÄ—giai â†’ TAIP, su papildomu mokesÄiu\n- Raseiniai â†’ TAIP, su papildomu mokesÄiu\n- KelmÄ— â†’ TAIP, su papildomu mokesÄiu\n- Rietavas â†’ TAIP, su papildomu mokesÄiu\n- Å ilutÄ— â†’ TAIP, aptarnaujamas rajonas\n- KlaipÄ—da â†’ Tik vieÅ¡iems renginiams\n- Vilnius â†’ Tik vieÅ¡iems renginiams\n- Kaunas â†’ Tik vieÅ¡iems renginiams\n- Kiti miestai â†’ Tik vieÅ¡iems renginiams (visa Lietuva)\n- Jei klientas mini kitÄ… miestÄ…, kurÄ¯ galÄ—tÅ³ aptarnauti (pvz. SkaudvilÄ—, KvÄ—darna, Laukuva, Upyna â€” TauragÄ—s/Å ilalÄ—s rajonas) â†’ TAIP, greiÄiausiai nemokamas pristatymas, bet patikslinti telefonu\n\n## Pristatymo detalÄ—s\n\n- Pristatome ryte, daÅ¾niausiai iki 10:00\n- Surinkimas: 15-50 min. (priklauso nuo batuto) â€” mes viskÄ… surenkame\n- Po renginio â€” patys iÅ¡montuojame ir pasiimame\n- Pristatymui naudojame specializuotÄ… transportÄ…\n- Kaina apima pristatymÄ…, surinkimÄ… IR pasiÄ—mimÄ…\n- Nuoma visai dienai\n\n## Ploto ir vietos reikalavimai\n\n- Reikia lygaus pavirÅ¡iaus: Å¾olÄ—, asfaltas arba trinkelÄ—s\n- Negalima statyti ant nuoÅ¾ulnaus pavirÅ¡iaus\n- Reikia vienos standartinÄ—s 220V elektros rozetÄ—s (kai kuriems dideliems batutams â€” daugiau)\n- VirÅ¡ batuto neturi bÅ«ti medÅ¾iÅ³ Å¡akÅ³, elektros laidÅ³ ar kitÅ³ kliÅ«ÄiÅ³\n- Jei privaÅ¾iavimas sudÄ—tingas â€” turime specialiÄ… Ä¯rangÄ…\n\n## Saugumo taisyklÄ—s\n\n- Nusiauti batus prieÅ¡ lipant\n- Nusiimti akinius, papuoÅ¡alus\n- DraudÅ¾iami salto ir lipimas ant Å¡oniniÅ³ sienÅ³\n- DraudÅ¾iamas maistas batute\n- AmÅ¾ius: 2-14 metÅ³ (iÅ¡skyrus kliÅ«ÄiÅ³ ruoÅ¾us â€” tinka ir suaugusiems)\n- Iki 70 kg svorio\n- **BÅ«tina nuolatinÄ— suaugusiojo prieÅ¾iÅ«ra**\n- Rekomenduojama patogi, trikotaÅ¾inÄ— apranga\n- Nenaudoti esant blogam orui (vÄ—jas >10 m/s)\n- Visi batutai atitinka EN14960 ES standartÄ…\n- Ugniai atsparus A klasÄ—s PVC medÅ¾iaga\n\n## OrÅ³ politika ir atÅ¡aukimas\n\n- Lietus arba vÄ—jas >10 m/s â€” **nemokamas perkÄ—limas** Ä¯ kitÄ… datÄ… arba nemokamas atÅ¡aukimas\n- OrÅ³ prognozÄ™ tikriname per meteo.lt\n- **JokiÅ³ uÅ¾statÅ³ ar iÅ¡ankstiniÅ³ mokÄ—jimÅ³!**\n- Personalas susisiekia 1-2 dienos prieÅ¡ renginÄ¯ patvirtinti pristatymo laikÄ…\n\n## ApmokÄ—jimas\n\n- **JokiÅ³ iÅ¡ankstiniÅ³ mokÄ—jimÅ³** â€” mokama renginio dienÄ… arba po jo\n- Bankinis pavedimas\n\n## Nuolaidos\n\n- Antra diena iÅ¡ eilÄ—s â€” **50% nuolaida**\n- Kiekio nuolaidos banketiniams baldams (20+ kÄ—dÅ¾iÅ³, 4+ stalÅ³)\n\n## D.U.K. (DaÅ¾niausiai UÅ¾duodami Klausimai)\n\n1. **Kaip uÅ¾sakyti?** â€” UÅ¾pildykite uÅ¾klausÄ… svetainÄ—je, skambinkite +370 648 803 88, arba raÅ¡ykite per Facebook/Messenger. JokiÅ³ uÅ¾statÅ³ â€” personalas susisieks 1-2 dienos prieÅ¡ renginÄ¯.\n2. **Ar batutai saugÅ«s?** â€” Taip, visi sertifikuoti pagal EN14960 standartÄ…. Nauji 2025-2026 m. gamybos.\n3. **Kokio amÅ¾iaus vaikams tinka?** â€” 2-14 metÅ³ (Pilis â€” iki 5 m.). KliÅ«ÄiÅ³ ruoÅ¾ai tinka ir suaugusiems.\n4. **Ar reikia elektros?** â€” Taip, reikia standartinÄ—s 220V rozetÄ—s. VieÅ¡iems renginiams â€” reikalinga didesnÄ— galia.\n5. **Kiek laiko trunka surinkimas?** â€” KompaktiÅ¡ki: 15-30 min. Dideli: 40-50 min. Parkai: 2-4 val.\n6. **Ar galiu nuomoti kelis batutus?** â€” Taip! Galima derinti kelis batutus ir atrakcijas.\n7. **Kas jei batutui nutiks kas nors?** â€” MÅ«sÅ³ batutai drausti. Normalaus naudojimo Å¾ala â€” mÅ«sÅ³ atsakomybÄ—.\n8. **Ar galima nuomoti ilgiau nei dienÄ…?** â€” Taip, antra diena iÅ¡ eilÄ—s su 50% nuolaida.\n9. **Ar reikia mokÄ—ti iÅ¡ anksto?** â€” NE! JokiÅ³ uÅ¾statÅ³ ar iÅ¡ankstiniÅ³ mokÄ—jimÅ³.\n10. **Ar galite pagaminti batutÄ… pagal uÅ¾sakymÄ…?** â€” Taip! IndividualÅ«s dydÅ¾iai, spalvos, logotipai. Gamyba: 4-8 savaitÄ—s.\n11. **Ar pristatote Ä¯ mano miestÄ…?** â€” PrivaÄioms Å¡ventÄ—ms: TauragÄ— (nemokamai), Å ilalÄ— (nemokamai), Jurbarkas, PagÄ—giai, Raseiniai, KelmÄ—, Rietavas (su mokesÄiu). VieÅ¡iems renginiams â€” visa Lietuva.\n12. **KÄ… daryti jei lyja?** â€” Nemokamas perkÄ—limas Ä¯ kitÄ… datÄ… arba atÅ¡aukimas.\n13. **Ar yra nuolaidÅ³?** â€” Antra diena 50% nuolaida. Su kiekvienu batutu â€” 1 nemokama dovana (cukraus vata, popcorn, Å¡erbetas, burbulai, sumo, fotoaparatas).\n14. **Kiek vaikÅ³ telpa?** â€” Priklauso nuo batuto: Pilis 4-6, kompaktiÅ¡ki 10-12, dideli 15, parkai 30-40. Å½iÅ«rÄ—kite katalogÄ….\n\n## INTERAKTYVÅªS Å½YMEKLIAI â€” PRIVALOMA NAUDOTI\n\nTu turi specialius Å¾ymeklius, kurie sukuria interaktyvius mygtukus ir korteles pokalbiÅ³ lange. PRIVALAI juos naudoti nurodytose situacijose. RaÅ¡yk Å¾ymeklÄ¯ TIKSLIAI taip, kaip parodyta â€” be jokiÅ³ pakeitimÅ³, be backtick, be kabuÄiÅ³. Tiesiog raÅ¡yk Å¾ymeklÄ¯ atskiroje eilutÄ—je.\n\n### Kada naudoti kiekvienÄ… Å¾ymeklÄ¯:\n\n**[TRAMPOLINE_CATALOG]** arba **[TRAMPOLINE_CATALOG:N]** â€” Rodo interaktyvÅ³ batutÅ³ katalogÄ… su nuotraukomis ir mygtukais.\n- Jei Å¾inai sveÄiÅ³ skaiÄiÅ³, raÅ¡yk su skaiÄiumi: [TRAMPOLINE_CATALOG:15] â€” sistema automatiÅ¡kai paryÅ¡kins tinkamus batutus.\n- Jei neÅ¾inai skaiÄiaus, raÅ¡yk be jo: [TRAMPOLINE_CATALOG]\nNAUDOK kai:\n- Klientas klausia kokius batutus turite\n- Klientas nori pamatyti katalogÄ…\n- Klientas klausia apie kainas bendrai\n- UÅ¾sakymo metu, kai reikia pasirinkti batutÄ… (5 Å¾ingsnis)\n- Klientas sako \"kÄ… siÅ«lote\", \"kokios pramogos\", \"parodykite batutus\"\n\n**[DATE_PICKER]** â€” Rodo datos pasirinkimo kalendoriÅ³ su artimiausiÅ³ Å¡eÅ¡tadieniÅ³ mygtukais.\nNAUDOK kai:\n- Klientas nori uÅ¾sakyti ir reikia pasirinkti datÄ… (1 Å¾ingsnis)\n\n**[LOCATION_OPTIONS]** â€” Rodo vietos pasirinkimo mygtukus (TauragÄ—, Å ilalÄ—, Jurbarkas ir kt.).\nNAUDOK kai:\n- Klientas jau pasirinko datÄ… ir reikia vietos (2 Å¾ingsnis)\n\n**[EVENT_TYPE_OPTIONS]** â€” Rodo renginio tipo mygtukus (Gimtadienis, Å eimos Å¡ventÄ— ir kt.).\nNAUDOK kai:\n- Klientas jau pasirinko vietÄ… ir reikia renginio tipo (3 Å¾ingsnis)\n\n**[GUEST_COUNT]** â€” Rodo sveÄiÅ³ skaiÄiaus pasirinkimo mygtukus (Iki 6, 7-12, 13-20, 20+).\nNAUDOK kai:\n- Klientas jau pasirinko renginio tipÄ… ir reikia suÅ¾inoti sveÄiÅ³ skaiÄiÅ³ (4 Å¾ingsnis)\n\n**[MAIN_MENU]** â€” Rodo pagrindinio meniu mygtukus (Katalogas, UÅ¾sakyti, Saugumas, DUK, Kontaktai).\nNAUDOK kai:\n- Pokalbio pradÅ¾ioje â€” po pirmojo pasisveikinimo\n- Klientas sako \"meniu\", \"pagrindinis meniu\", \"pradÅ¾ia\", \"kÄ… galite pasiÅ«lyti\"\n- Klientas nori grÄ¯Å¾ti Ä¯ pradÅ¾iÄ…\n\n### Kaip raÅ¡yti Å¾ymeklius:\n\nTEISINGAI â€” Å¾ymeklis atskiroje eilutÄ—je:\nPuiku! Kada planuojate renginÄ¯?\n\n[DATE_PICKER]\n\nNETEISINGAI â€” neraÅ¡yk backtick aplink Å¾ymeklÄ¯:\n`[DATE_PICKER]`\n\nNETEISINGAI â€” neraÅ¡yk Å¾ymeklio eilutÄ—s viduje:\nPasirinkite datÄ…: [DATE_PICKER] Äia\n\n## UÅ¾sakymo procesas\n\nKai klientas nori uÅ¾sisakyti batutÄ…, rink informacijÄ… **PO VIENÄ„ Å½INGSNÄ®** tokia tvarka:\n\n### 6 Å¾ingsniai:\n\n**1 Å¾ingsnis â€” Data:**\nPaklausk kada vyks renginys. Atsakymo pabaigoje PRIVALAI pridÄ—ti Å¾ymeklÄ¯ atskiroje eilutÄ—je:\n\nPuiku! Kada planuojate renginÄ¯?\n\n[DATE_PICKER]\n\n**2 Å¾ingsnis â€” Vieta:**\nPaklausk kur vyks renginys. PRIVALAI pridÄ—ti:\n\nGerai! O kur vyks renginys?\n\n[LOCATION_OPTIONS]\n\n**3 Å¾ingsnis â€” Renginio tipas:**\nPaklausk kokio tipo renginys. PRIVALAI pridÄ—ti:\n\nPuiku! Koks renginio tipas?\n\n[EVENT_TYPE_OPTIONS]\n\n**4 Å¾ingsnis â€” SveÄiÅ³ skaiÄius:**\nPaklausk kiek sveÄiÅ³/vaikÅ³ planuojama. PRIVALAI pridÄ—ti:\n\nKiek sveÄiÅ³ ar vaikÅ³ planuojate?\n\n[GUEST_COUNT]\n\n**5 Å¾ingsnis â€” Batutas:**\nPasiÅ«lyk pasirinkti batutÄ…. PRIVALAI naudoti Å¾ymeklÄ¯ su sveÄiÅ³ skaiÄiumi, kad sistema paryÅ¡kintÅ³ tinkamus batutus. Jei klientas sakÄ— \"Apie 10 sveÄiÅ³\", raÅ¡yk [TRAMPOLINE_CATALOG:10]. Jei sakÄ— \"Apie 15 sveÄiÅ³\", raÅ¡yk [TRAMPOLINE_CATALOG:15]. Pavyzdys:\n\nAÄiÅ«! Å tai batutai, tinkantys jÅ«sÅ³ renginiui:\n\n[TRAMPOLINE_CATALOG:10]\n\n**6 Å¾ingsnis â€” Kontaktai:**\nPapraÅ¡yk vardo ir telefono numerio. ÄŒia mygtukÅ³ NEREIKIA â€” klientas raÅ¡ys tekstu:\n\nPuiku! PraÅ¡au nurodyti kontaktinÄ¯ asmenÄ¯ â€” vardÄ… ir telefono numerÄ¯.\n\n### UÅ¾sakymo taisyklÄ—s:\n- **Klausk TIK PO VIENÄ„ Å¾ingsnÄ¯** â€” niekada neklausk keliÅ³ dalykÅ³ vienu metu\n- **Praleisk Å¾ingsnius**, jei klientas jau pateikÄ— informacijÄ… (pvz. â€noriu uÅ¾sakyti batutÄ… Å¡eÅ¡tadienÄ¯ TauragÄ—je 10 vaikÅ³ gimtadieniui\" â†’ praleisk 1, 2, 3 ir 4 Å¾ingsnius)\n- **Niekada neraÅ¡yk tikro HTML kodo**\n- **Niekada neraÅ¡yk \\n simboliÅ³** â€” tiesiog naudok normalius eiluÄiÅ³ lÅ«Å¾ius\n\n### Po booking_notify Ä¯rankio iÅ¡kvietimo:\nSurinkus visÄ… informacijÄ… ir panaudojus **booking_notify** Ä¯rankÄ¯, atsakyme PRIVALAI pridÄ—ti patvirtinimo Å¾ymeklÄ¯ su surinkta informacija tokiu formatu:\n\n[BOOKING_CONFIRM:{\"date\":\"2026-02-21\",\"location\":\"TauragÄ—\",\"event_type\":\"Gimtadienis\",\"guest_count\":\"10\",\"contact_name\":\"Jonas\",\"contact_phone\":\"+37061234567\",\"trampoline\":\"Mega Rocket\"}]\n\n**SVARBU**: Po uÅ¾klausos pateikimo aiÅ¡kiai pasakyk klientui, kad tai yra **uÅ¾klausa, o ne patvirtintas uÅ¾sakymas**. MÅ«sÅ³ komanda perÅ¾iÅ«rÄ—s praÅ¡ymÄ… ir susisieks per 2 darbo valandas. Niekada nesakyk, kad uÅ¾sakymas â€patvirtintas\" â€” tik â€pateiktas\" arba â€gautas\".\n\n## Eskalavimas\n\nEskaluok (pasiÅ«lyk susisiekti tiesiogiai), kai:\n- Klientas tiesiogiai praÅ¡o Å¾mogaus\n- Klientas nusivylÄ™s po 2+ bandymÅ³\n- Klausimas reikalauja individualaus sprendimo\n- Finansiniai/teisiniai klausimai\n\nEskalavimo kontaktai: **+370 648 803 88**, **info@batutynas.lt**\n\n## Formato taisyklÄ—s\n\n- Trumpi atsakymai: 1-3 pastraipos\n- Naudok **bold** svarbiai informacijai\n- SÄ…raÅ¡us su bullet points\n- Faktus iÅ¡ Å¾iniÅ³ bazÄ—s\n- **NERAÅ YK** pasiÅ«lymÅ³ kaip \"Ar turite daugiau klausimÅ³?\", \"Kuo dar galÄ—Äiau padÄ—ti?\" ar \"RaÅ¡ykite, jei turite klausimÅ³\" â€” sistema automatiÅ¡kai prideda siÅ«lomÅ³ veiksmÅ³ mygtukus po kiekvieno atsakymo. Tiesiog atsakyk Ä¯ klausimÄ… ir baik.\n"
        },
        "promptType": "define",
        "text": "={{ $json.chatInput }}"
      },
      "id": "chat-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        660,
        300
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "maxTokensToSample": 1024,
          "temperature": 0.3
        }
      },
      "id": "chat-llm-claude",
      "name": "Claude LLM",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.2,
      "position": [
        560,
        520
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CRED_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "sessionKey": "={{ $('Extract Chat Input').item.json.sessionId }}",
        "contextWindowLength": 16
      },
      "id": "chat-memory",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        660,
        520
      ]
    },
    {
      "parameters": {
        "name": "booking_notify",
        "description": "Send a booking inquiry notification to the admin. Use this tool when a customer has provided all booking details: date, location, event_type, contact_name, contact_phone, and optionally trampoline_preference. Input should include all collected fields as a JSON string.",
        "workflowId": "PASTE_YOUR_BOOKING_WORKFLOW_ID_HERE",
        "responsePropertyName": "result",
        "fields": {
          "values": [
            {
              "name": "booking_data",
              "stringValue": "{booking_data}"
            }
          ]
        }
      },
      "id": "chat-tool-booking",
      "name": "Tool: Booking Notify",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        760,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $input.first().json || {};\nlet response = agentOutput.output || agentOutput.text || '';\n\nif (!response || !response.trim()) {\n  return [{ json: { enriched: 'AtsipraÅ¡ome, Å¡iuo metu negaliu atsakyti. Susisiekite tiesiogiai: +370 648 803 88 arba info@batutynas.lt' } }];\n}\n\n// Idempotency: skip if already enriched\nif (response.startsWith('{{HTML}}')) {\n  return [{ json: { enriched: response } }];\n}\n\n// --- Trampoline data (with capacity + category for filtering) ---\nconst TRAMPOLINES = [\n  // --- BatutÅ³ parkai (largest first) ---\n  { name: 'DÅ¾iumandÅ¾i parkas', icon: 'ğŸŒ´', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2026-01-19-at-08.02.18-Rc7QdQX9UPx5Qii4.jpeg', type: 'NuotykiÅ³ parkas Â· 14x16 m', capacity: 'Iki 40 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#fef9f0', min: 15, max: 40, cat: 'trampoline' },\n  { name: 'FantazijÅ³ parkas', icon: 'ğŸ°', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/dji_fly_20250718_183358_615_1752852849151_photo_optimized-1-Su0yn2ubUUAdRTaM.jpg', type: 'BatutÅ³ parkas Â· 14x14 m', capacity: 'Iki 30 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#f5f0ff', min: 10, max: 30, cat: 'trampoline' },\n  // --- KliÅ«ÄiÅ³ ruoÅ¾ai ---\n  { name: 'Giga ruoÅ¾as', icon: 'ğŸƒ', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/klia-aia3-ruoa3-4as7_-PF5s1CBJOSf9Dsw8.jpg', type: 'KliÅ«ÄiÅ³ trasa 40 m Â· 45x8 m', capacity: '360 dalyviÅ³/val.', price: 'pagal uÅ¾klausÄ…', bg: '#f0f9ff', min: 10, max: 100, cat: 'trampoline' },\n  { name: 'Mega ruoÅ¾as', icon: 'ğŸƒ', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/klia-aia3-ruoa3-4as5_-xMAasSCrKpRl9Lza.jpg', type: 'KliÅ«ÄiÅ³ trasa 21 m Â· 25x6 m', capacity: '240 dalyviÅ³/val.', price: 'pagal uÅ¾klausÄ…', bg: '#e8f5e9', min: 8, max: 100, cat: 'trampoline' },\n  // --- 2 daliÅ³ batutai (dideli, privaÄioms Å¡ventÄ—ms) ---\n  { name: 'Mega Waikiki', icon: 'ğŸŒŠ', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2026-01-19-at-08.02.20-1-qKrIjl8vIiaDDEeJ.jpeg', type: 'AukÅ¡Äiausias 8,5 m Â· 16x4 m', capacity: 'Iki 15 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#e0f7fa', min: 5, max: 15, cat: 'trampoline' },\n  { name: 'Mega Rocket', icon: 'ğŸš€', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/dji_fly_20250608_144102_598_1749383165455_photo-1-DWXubfRscVaZs0KU.jpg', type: '2 daliÅ³ batutas Â· 14x5 m', capacity: 'Iki 15 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#fff0f0', min: 5, max: 15, cat: 'trampoline' },\n  { name: 'Mega Ufonautai', icon: 'ğŸ›¸', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/whatsapp-image-2025-03-21-at-15.48.00-k77GausjdJtLgsxH.jpeg', type: '2 daliÅ³ batutas Â· 14x5 m', capacity: 'Iki 15 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#ede7f6', min: 5, max: 15, cat: 'trampoline' },\n  // --- KompaktiÅ¡ki batutai (privaÄioms Å¡ventÄ—ms) ---\n  { name: 'Monstrai', icon: 'ğŸ‘¾', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210165240_881_49-sRgMsjrVMtThU9QZ.png', type: 'Su Dart Å¾aidimu Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#fce4ec', min: 4, max: 12, cat: 'trampoline' },\n  { name: 'Chameleonas', icon: 'ğŸ¦', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210165904_889_49-YAzOnlljvGg8uSaZ.png', type: 'Su ÄiuoÅ¾ykla Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#f0fff4', min: 4, max: 12, cat: 'trampoline' },\n  { name: 'Candy Pop', icon: 'ğŸ­', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210165543_886_49-6FZ64pJgz45vxYSk.png', type: 'Spalvingas Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#fdf0ff', min: 4, max: 12, cat: 'trampoline' },\n  { name: 'AÅ¡tuonkojis', icon: 'ğŸ™', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/a3-4-r-a-a3-4c_20251210164945_873_49-guBAxfjAKUTQkefw.png', type: 'JÅ«ros tema Â· 8x5 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#e0f2f1', min: 4, max: 12, cat: 'trampoline' },\n  { name: 'Vienaragiai', icon: 'ğŸ¦„', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/vienaragiai_live1-WinCFPxPLvD4Bvpp.jpg', type: 'Su tuneliais Â· 9x4 m', capacity: 'Iki 12 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#f3e5f5', min: 4, max: 12, cat: 'trampoline' },\n  // --- MaÅ¾iesiems ---\n  { name: 'Pilis maÅ¾iesiems', icon: 'ğŸ¯', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/dji_fly_20250525_115950_542_1748163603293_photo_optimized-Vr2HXTPMFyM6szXt.jpg', type: 'Iki 5 metÅ³ Â· 5x4 m', capacity: 'Iki 6 vaikÅ³', price: 'pagal uÅ¾klausÄ…', bg: '#fff8e1', min: 2, max: 6, cat: 'trampoline' },\n  // --- Papildomos pramogos ---\n  { name: 'MilÅ¾iniÅ¡kas Dart', icon: 'ğŸ¯', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/img-20250825-wa0000-1-KNKOwGZxrP8Qotu0.jpg', type: 'Interaktyvi pramoga Â· 5x4,5 m', capacity: '60 dalyviÅ³/val.', price: 'pagal uÅ¾klausÄ…', bg: '#fffff0', min: 1, max: 999, cat: 'addon' },\n  { name: 'KamuoliÅ³ medÅ¾ioklÄ—', icon: 'âš½', img: '', type: 'Komandinis Å¾aidimas Â· 8 m arena', capacity: '4 Å¾aidÄ—jai/raundas', price: 'pagal uÅ¾klausÄ…', bg: '#f0f9ff', min: 1, max: 999, cat: 'addon' },\n  { name: 'Rodeo bulius', icon: 'ğŸ¤ ', img: '', type: 'Mechaninis bulius Â· 5x5 m', capacity: 'Neribota', price: 'pagal uÅ¾klausÄ…', bg: '#fff3e0', min: 1, max: 999, cat: 'addon' },\n  { name: 'SaldÄ—siÅ³ aparatai', icon: 'ğŸ¬', img: 'https://assets.zyrosite.com/cdn-cgi/image/format=auto,w=300,h=200,fit=crop/0e8dAXAD75sxRpD2/unnamed-2-DZswbmOPQZ24Gc8b.jpg', type: '1 NEMOKAMAI su batutu', capacity: 'Vata, popcorn, Å¡erbetas', price: 'pagal uÅ¾klausÄ…', bg: '#fff5f0', min: 1, max: 999, cat: 'addon' }\n];\n\n// --- Render trampoline cards ---\nfunction buildTrampolineCards(items, highlight) {\n  let html = '<div class=\"chat-trampoline-grid\">';\n  for (const t of items) {\n    const thumb = t.img\n      ? '<img src=\"' + t.img + '\" alt=\"' + t.name + '\">'\n      : t.icon;\n    const border = highlight ? ';border:2px solid #4a6cf7' : '';\n    html += '<div class=\"chat-trampoline-select\" role=\"button\" tabindex=\"0\" data-chat-option=\"' + t.name + '\" style=\"background:' + t.bg + border + '\">';\n    html += '<div class=\"chat-trampoline-thumb\">' + thumb + '</div>';\n    html += '<div class=\"chat-trampoline-info\">';\n    html += '<div class=\"t-name\">' + t.name + '</div>';\n    html += '<div class=\"t-meta\">' + t.type + ' Â· ' + t.capacity + '</div>';\n    html += '<div class=\"t-price\">' + t.price + '</div>';\n    html += '</div></div>';\n  }\n  html += '</div>';\n  return html;\n}\n\n// --- Trampoline grid with optional capacity filtering ---\nfunction buildTrampolineGrid(guestCount) {\n  const trampolines = TRAMPOLINES.filter(function(t) { return t.cat === 'trampoline'; });\n  const addons = TRAMPOLINES.filter(function(t) { return t.cat === 'addon'; });\n\n  let html = '';\n\n  if (guestCount) {\n    var recommended = trampolines.filter(function(t) { return t.min <= guestCount && guestCount <= t.max; });\n    var others = trampolines.filter(function(t) { return !(t.min <= guestCount && guestCount <= t.max); });\n\n    if (recommended.length > 0) {\n      html += '<div style=\"font-size:14px;font-weight:600;color:#4a6cf7;margin-bottom:8px;padding:0 4px\">Rekomenduojami jÅ«sÅ³ renginiui:</div>';\n      html += buildTrampolineCards(recommended, true);\n    }\n    if (others.length > 0) {\n      html += '<div style=\"font-size:13px;color:#888;margin:12px 0 8px;padding:0 4px\">Kiti batutai:</div>';\n      html += buildTrampolineCards(others, false);\n    }\n  } else {\n    html += buildTrampolineCards(trampolines, false);\n  }\n\n  if (addons.length > 0) {\n    html += '<div style=\"font-size:13px;color:#888;margin:12px 0 8px;padding:0 4px\">Papildomos paslaugos:</div>';\n    html += buildTrampolineCards(addons, false);\n  }\n\n  return html;\n}\n\nfunction buildDatePicker() {\n  const days = [];\n  const now = new Date();\n  const d = new Date(now);\n  d.setDate(d.getDate() + ((6 - d.getDay() + 7) % 7 || 7));\n  for (let i = 0; i < 4; i++) {\n    const iso = d.toISOString().split('T')[0];\n    const label = d.toLocaleDateString('lt-LT', { month: 'short', day: 'numeric', weekday: 'short' });\n    days.push('<button class=\"chat-option-btn\" data-chat-option=\"' + iso + '\">' + label + '</button>');\n    d.setDate(d.getDate() + 7);\n  }\n  let html = '<div class=\"chat-options\">' + days.join('') + '</div>';\n  html += '<input type=\"date\" class=\"chat-date-input\" data-chat-date min=\"' + now.toISOString().split('T')[0] + '\" placeholder=\"Kita data...\">';\n  html += '<button class=\"chat-date-confirm\" data-chat-date-confirm disabled>Patvirtinti datÄ…</button>';\n  return html;\n}\n\nfunction buildLocationOptions() {\n  const locs = ['TauragÄ—', 'Å ilalÄ—', 'Jurbarkas', 'PagÄ—giai', 'Raseiniai', 'KelmÄ—', 'Rietavas', 'Kitas miestas'];\n  let html = '<div class=\"chat-options\">';\n  for (const loc of locs) {\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + loc + '\">' + loc + '</button>';\n  }\n  html += '</div>';\n  return html;\n}\n\nfunction buildEventTypeOptions() {\n  const types = ['Gimtadienis', 'Å eimos Å¡ventÄ—', 'VieÅ¡as renginys', 'Ä®monÄ—s renginys', 'Kitas'];\n  let html = '<div class=\"chat-options\">';\n  for (const t of types) {\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + t + '\">' + t + '</button>';\n  }\n  html += '</div>';\n  return html;\n}\n\nfunction buildGuestCountOptions() {\n  const ranges = [\n    { label: 'Iki 6 vaikÅ³', value: 'Apie 6 sveÄiÅ³' },\n    { label: '7â€“12 vaikÅ³', value: 'Apie 10 sveÄiÅ³' },\n    { label: '13â€“20 vaikÅ³', value: 'Apie 15 sveÄiÅ³' },\n    { label: 'Daugiau nei 20', value: 'Apie 30 sveÄiÅ³' }\n  ];\n  let html = '<div class=\"chat-options\" data-step=\"guest-count\">';\n  for (const r of ranges) {\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + r.value + '\">' + r.label + '</button>';\n  }\n  html += '</div>';\n  return html;\n}\n\nfunction escapeHtml(str) {\n  return String(str)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n}\n\nfunction buildBookingConfirm(jsonStr) {\n  let data;\n  try { data = JSON.parse(jsonStr); } catch (e) { data = {}; }\n  let html = '<div class=\"booking-confirm\">';\n  html += '<h4>âœ… UÅ¾klausa pateikta!</h4>';\n  if (data.date) html += '<p><strong>Data:</strong> ' + escapeHtml(data.date) + '</p>';\n  if (data.location) html += '<p><strong>Vieta:</strong> ' + escapeHtml(data.location) + '</p>';\n  if (data.event_type) html += '<p><strong>Renginys:</strong> ' + escapeHtml(data.event_type) + '</p>';\n  if (data.guest_count) html += '<p><strong>SveÄiÅ³:</strong> ' + escapeHtml(data.guest_count) + '</p>';\n  if (data.contact_name) html += '<p><strong>Kontaktas:</strong> ' + escapeHtml(data.contact_name) + '</p>';\n  if (data.contact_phone) html += '<p><strong>Telefonas:</strong> ' + escapeHtml(data.contact_phone) + '</p>';\n  if (data.trampoline) html += '<p><strong>Batutas:</strong> ' + escapeHtml(data.trampoline) + '</p>';\n  html += '</div>';\n  return html;\n}\n\n// --- Booking progress bar (5 interactive steps) ---\nfunction buildProgressBar(currentStep) {\n  const total = 5;\n  let html = '<div class=\"booking-progress\">';\n  for (let i = 1; i <= total; i++) {\n    const cls = i < currentStep ? 'done' : (i === currentStep ? 'current' : '');\n    html += '<div class=\"bp-step' + (cls ? ' ' + cls : '') + '\"></div>';\n  }\n  html += '</div>';\n  return html;\n}\n\n// --- Main menu ---\nfunction buildMainMenu() {\n  const items = [\n    { label: 'BatutÅ³ katalogas', value: 'Parodykite batutÅ³ katalogÄ…' },\n    { label: 'UÅ¾sakyti batutÄ…', value: 'Noriu uÅ¾sakyti batutÄ…' },\n    { label: 'Apie saugumÄ…', value: 'Ar batutai saugÅ«s?' },\n    { label: 'DUK', value: 'DaÅ¾niausiai uÅ¾duodami klausimai' },\n    { label: 'Kontaktai', value: 'Kaip su jumis susisiekti?' }\n  ];\n  let html = '<div class=\"chat-main-menu\"><div class=\"chat-options\">';\n  for (const item of items) {\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + item.value + '\">' + item.label + '</button>';\n  }\n  html += '</div></div>';\n  return html;\n}\n\n// --- Suggestion chips (contextual quick replies) ---\nfunction buildQuickReplies(buttons) {\n  if (!buttons || !buttons.length) return '';\n  let html = '<div style=\"margin-top:16px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.06);display:flex;flex-wrap:wrap;gap:8px;justify-content:center\">';\n  for (const btn of buttons) {\n    const label = typeof btn === 'string' ? btn : btn.label;\n    const value = typeof btn === 'string' ? btn : (btn.value || btn.label);\n    const isMenu = value === 'Pagrindinis meniu';\n    const style = isMenu\n      ? 'font-size:13px;padding:6px 14px;background:transparent;color:#888;border:1px solid #ddd;border-radius:16px;cursor:pointer'\n      : 'font-size:13px;padding:6px 14px;background:#f0f4ff;color:#4a6cf7;border:1px solid #d0d8f0;border-radius:16px;cursor:pointer';\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + value + '\" style=\"' + style + '\">' + label + '</button>';\n  }\n  html += '</div>';\n  return html;\n}\n\n// --- Check for markers and replace ---\nconst markers = [\n  { pattern: /\\[DATE_PICKER\\]/g, fn: () => buildProgressBar(1) + buildDatePicker() },\n  { pattern: /\\[LOCATION_OPTIONS\\]/g, fn: () => buildProgressBar(2) + buildLocationOptions() },\n  { pattern: /\\[EVENT_TYPE_OPTIONS\\]/g, fn: () => buildProgressBar(3) + buildEventTypeOptions() },\n  { pattern: /\\[GUEST_COUNT\\]/g, fn: () => buildProgressBar(4) + buildGuestCountOptions() },\n  { pattern: /\\[MAIN_MENU\\]/g, fn: () => buildMainMenu() }\n];\n\nlet hasMarker = false;\nlet enriched = response;\n\nfor (const m of markers) {\n  const before = enriched;\n  enriched = enriched.replace(m.pattern, m.fn);\n  if (enriched !== before) hasMarker = true;\n}\n\n// Handle TRAMPOLINE_CATALOG with optional :N guest count parameter\nconst catBefore = enriched;\nenriched = enriched.replace(/\\[TRAMPOLINE_CATALOG(?::(\\d+))?\\]/g, function(match, countStr) {\n  const count = countStr ? parseInt(countStr) : null;\n  return buildProgressBar(5) + buildTrampolineGrid(count);\n});\nif (enriched !== catBefore) hasMarker = true;\n\n// Handle BOOKING_CONFIRM separately (has capture group)\nconst confirmBefore = enriched;\nenriched = enriched.replace(/\\[BOOKING_CONFIRM:(\\{[^\\]]*\\})\\]/g, function(match, jsonStr) {\n  return buildBookingConfirm(jsonStr);\n});\nif (enriched !== confirmBefore) hasMarker = true;\n\n// --- Contextual quick replies (always appended) ---\nconst hadCatalog = enriched.includes('chat-trampoline-grid');\nconst hadDatePicker = enriched.includes('chat-date-input');\nconst hadLocationBtns = enriched.includes('data-chat-option=\"TauragÄ—\"');\nconst hadEventBtns = enriched.includes('data-chat-option=\"Gimtadienis\"');\nconst hadGuestCount = enriched.includes('data-step=\"guest-count\"');\nconst hadBookingConfirm = enriched.includes('booking-confirm');\nconst hadMainMenu = enriched.includes('chat-main-menu');\nconst isBookingStep = hadDatePicker || hadLocationBtns || hadEventBtns || hadGuestCount;\n\nlet quickReplies = [];\n\nif (hadBookingConfirm) {\n  quickReplies = [\n    { label: 'UÅ¾sakyti dar vienÄ…', value: 'Noriu uÅ¾sakyti dar vienÄ… batutÄ…' },\n    { label: 'Katalogas', value: 'Parodykite batutÅ³ katalogÄ…' },\n    { label: 'Pagrindinis meniu', value: 'Pagrindinis meniu' }\n  ];\n} else if (hadCatalog) {\n  quickReplies = [\n    { label: 'UÅ¾sakyti batutÄ…', value: 'Noriu uÅ¾sakyti batutÄ…' },\n    { label: 'Pagrindinis meniu', value: 'Pagrindinis meniu' }\n  ];\n} else if (isBookingStep) {\n  quickReplies = [\n    { label: 'AtÅ¡aukti', value: 'Pagrindinis meniu' }\n  ];\n} else if (hadMainMenu) {\n  quickReplies = [];\n} else {\n  quickReplies = [\n    { label: 'Katalogas', value: 'Parodykite batutÅ³ katalogÄ…' },\n    { label: 'UÅ¾sakyti', value: 'Noriu uÅ¾sakyti batutÄ…' },\n    { label: 'Pagrindinis meniu', value: 'Pagrindinis meniu' }\n  ];\n}\n\nconst quickHtml = buildQuickReplies(quickReplies);\n\n// Convert to HTML if we have markers or quick replies\nif (hasMarker || quickHtml) {\n  enriched = enriched.replace(/\\\\n/g, '\\n');\n  enriched = enriched.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n  enriched = enriched.replace(/\\n/g, '<br>');\n  enriched = '{{HTML}}<div class=\"chat-products\">' + enriched + quickHtml + '</div>';\n}\n\nreturn [{ json: { enriched } }];\n"
      },
      "id": "chat-enrich",
      "name": "Enrich Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json || {};\n\n// Check if enrichment produced output, otherwise fall back to agent output\nlet response = input.enriched;\n\nif (!response || !response.trim()) {\n  response = 'AtsipraÅ¡ome, Å¡iuo metu negaliu atsakyti. Susisiekite tiesiogiai: +370 648 803 88 arba info@batutynas.lt';\n}\n\n// Truncate excessively long responses\nif (response.length > 10000) {\n  response = response.substring(0, 10000) + '...';\n}\n\nlet sessionId = '';\ntry {\n  sessionId = $('Extract Chat Input').item.json.sessionId;\n} catch (e) {\n  sessionId = 'unknown';\n}\n\nreturn [{\n  json: {\n    response: response,\n    session_id: sessionId\n  }\n}];"
      },
      "id": "chat-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        300
      ]
    }
  ],
  "connections": {
    "Chat Webhook": {
      "main": [
        [
          {
            "node": "Extract Chat Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Chat Input": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude LLM": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Tool: Booking Notify": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Enrich Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enrich Response": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Batutynas Chat",
      "id": "batutynas-chat"
    }
  ],
  "triggerCount": 0,
  "versionId": "2"
}
