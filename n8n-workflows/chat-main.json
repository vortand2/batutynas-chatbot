{
  "name": "Batutynas: Chat Support Agent",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "batutynas-chat",
        "responseMode": "lastNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "={{ $env.SITE_DOMAIN || 'https://batutynas.lt' }}"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "chat-trigger",
      "name": "Chat Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [220, 300],
      "webhookId": "batutynas-chat"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || {};\n\nconst sessionId = String(body.session_id || 'anonymous-' + Date.now()).substring(0, 100);\n\n// Sanitize message: strip control chars, trim, enforce length limit\nlet message = String(body.message || '').replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '').trim();\nif (message.length > 2000) message = message.substring(0, 2000);\n\nconst userEmail = body.email ? String(body.email).substring(0, 254) : null;\nconst userName = body.name ? String(body.name).substring(0, 100) : null;\n\n// Validate language â€” only allow known values\nconst allowedLangs = ['lt', 'en'];\nconst rawLang = String(body.language || 'lt').toLowerCase().substring(0, 2);\nconst browserLang = allowedLangs.indexOf(rawLang) !== -1 ? rawLang : 'lt';\n\nreturn [{\n  json: {\n    sessionId,\n    message,\n    userEmail,\n    userName,\n    browserLang,\n    chatInput: message || 'Sveiki'\n  }\n}];"
      },
      "id": "chat-extract",
      "name": "Extract Chat Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "={{ $env.BATUTYNAS_SYSTEM_PROMPT || 'You are a friendly, professional customer support assistant for Batutynas.lt â€” a Lithuanian inflatable trampoline rental company operating since 2015, based in TauragÄ—, Lithuania. All trampolines are EN14960 certified.\\n\\nLANGUAGE: Always respond in the language the customer uses. Default: Lithuanian. If they write in English, respond in English.\\n\\nIMPORTANT â€” ANSWER ANY QUESTION: You must attempt to answer ANY question the customer asks, even if it is not directly related to trampoline rental. For business-related questions, use the knowledge below. For unrelated questions (weather, recipes, general knowledge), give a brief helpful answer and gently steer back to your services. Never say you cannot answer.\\n\\nSERVICES:\\n1. Private party rental: trampolines for birthdays, family events. From 50 EUR/day. Second consecutive day 50% off. Free delivery in TauragÄ—/Å ilalÄ—. Additional fee: Jurbarkas, PagÄ—giai, Raseiniai, KelmÄ—, Rietavas.\\n2. Public events: trampoline parks for festivals across ALL Lithuania. Individual pricing. Generators and service included.\\n3. Custom manufacturing: custom sizes, colors, logos. Production: 4-8 weeks.\\n\\nTRAMPOLINES: FantazijÅ³ parkas (park, 15 kids, 150 EUR), DÅ¾iumandÅ¾i parkas (adventure, 12 kids, 130 EUR), Mega kliÅ«ÄiÅ³ ruoÅ¾as (obstacle, 10 kids, 100 EUR), Mega Rocket (2-part, 8 kids, 80 EUR), Candy Pop (compact, 6 kids, 60 EUR), Chameleon (compact, 6 kids, 60 EUR), MilÅ¾iniÅ¡kas smiginis (interactive, unlimited, 50 EUR), Cukraus vatos aparatas (add-on, 30 EUR).\\n\\nDELIVERY: Morning delivery (usually by 10:00). Setup 15-30 min â€” we do everything. Pickup after event included.\\nSPACE: Small trampolines 5x5m, medium 7x6m, large parks 10x8m. Flat surface required (grass/asphalt), no overhead obstacles.\\nPAYMENT: Bank transfer. 50% deposit to confirm, balance on event day.\\nSAFETY: Ages 2-14, max 70 kg. Remove shoes and jewelry. No flips. Adult supervision under 6. No use in wind >10 m/s.\\nWEATHER: Rain/wind >10 m/s = free reschedule. Free cancellation >48h. Cancellation <24h = 50% fee.\\nINSURANCE: All trampolines insured. EN14960 certified. Normal use damage is our responsibility.\\nELECTRICITY: Private events need 220V outlet. Public events â€” generators included.\\nHOURS: 8:00-21:00 daily. Phone: +370 686 55557. Email: info@batutynas.lt. Facebook: facebook.com/batutynas.\\n\\nBOOKING: Collect date, location, event type, contact name, phone, trampoline preference. Then use booking_notify tool. IMPORTANT: After submitting, tell the customer this is an INQUIRY, not a confirmed booking. Team will contact within 2 business hours.\\n\\nESCALATE when: customer asks for human, frustrated after 2+ attempts, financial/legal questions. Contacts: +370 686 55557, info@batutynas.lt.\\n\\nFORMAT: Short answers (1-3 paragraphs). Use **bold** for key info. Bullet lists for details.' }}\n\nThe customer's browser language is: {{ $json.browserLang }}\nCustomer email (if known): {{ $json.userEmail }}\nCustomer name (if known): {{ $json.userName }}"
        },
        "promptType": "define",
        "text": "={{ $json.chatInput }}"
      },
      "id": "chat-agent",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [660, 300]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "maxTokensToSample": 1024,
          "temperature": 0.3
        }
      },
      "id": "chat-llm-claude",
      "name": "Claude LLM",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.2,
      "position": [560, 520],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CRED_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "sessionKey": "={{ $('Extract Chat Input').item.json.sessionId }}",
        "contextWindowLength": 16
      },
      "id": "chat-memory",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [660, 520]
    },
    {
      "parameters": {
        "name": "booking_notify",
        "description": "Send a booking inquiry notification to the admin. Use this tool when a customer has provided all booking details: date, location, event_type, contact_name, contact_phone, and optionally trampoline_preference. Input should include all collected fields as a JSON string.",
        "workflowId": "={{ $env.TOOL_BOOKING_NOTIFY_WORKFLOW_ID }}",
        "responsePropertyName": "result",
        "fields": {
          "values": [
            {
              "name": "booking_data",
              "stringValue": "{booking_data}"
            }
          ]
        }
      },
      "id": "chat-tool-booking",
      "name": "Tool: Booking Notify",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [760, 520]
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $input.first().json || {};\nlet response = agentOutput.output || agentOutput.text || '';\n\nif (!response || !response.trim()) {\n  return [{ json: { enriched: 'AtsipraÅ¡ome, Å¡iuo metu negaliu atsakyti. Susisiekite tiesiogiai: +370 686 55557 arba info@batutynas.lt' } }];\n}\n\n// Idempotency: skip if already enriched\nif (response.startsWith('{{HTML}}')) {\n  return [{ json: { enriched: response } }];\n}\n\n// --- Trampoline data (image-ready) ---\nconst TRAMPOLINES = [\n  { name: 'FantazijÅ³ parkas', icon: 'ðŸ°', img: '', type: 'BatutÅ³ parkas', capacity: 'Iki 15 vaikÅ³', price: 'nuo 150 â‚¬', bg: '#f5f0ff' },\n  { name: 'DÅ¾iumandÅ¾i parkas', icon: 'ðŸŒ´', img: '', type: 'NuotykiÅ³ parkas', capacity: 'Iki 12 vaikÅ³', price: 'nuo 130 â‚¬', bg: '#fef9f0' },\n  { name: 'Mega kliÅ«ÄiÅ³ ruoÅ¾as', icon: 'ðŸƒ', img: '', type: 'KliÅ«ÄiÅ³ ruoÅ¾as', capacity: 'Iki 10 vaikÅ³', price: 'nuo 100 â‚¬', bg: '#f0f9ff' },\n  { name: 'Mega Rocket', icon: 'ðŸš€', img: '', type: '2 daliÅ³ batutas', capacity: 'Iki 8 vaikÅ³', price: 'nuo 80 â‚¬', bg: '#fff0f0' },\n  { name: 'Candy Pop', icon: 'ðŸ­', img: '', type: 'KompaktiÅ¡kas', capacity: 'Iki 6 vaikÅ³', price: 'nuo 60 â‚¬', bg: '#fdf0ff' },\n  { name: 'Chameleon', icon: 'ðŸ¦Ž', img: '', type: 'KompaktiÅ¡kas', capacity: 'Iki 6 vaikÅ³', price: 'nuo 60 â‚¬', bg: '#f0fff4' },\n  { name: 'MilÅ¾iniÅ¡kas smiginis', icon: 'ðŸŽ¯', img: '', type: 'Interaktyvi pramoga', capacity: 'Neribota', price: 'nuo 50 â‚¬', bg: '#fffff0' },\n  { name: 'Cukraus vatos aparatas', icon: 'ðŸ¬', img: '', type: 'Papildoma paslauga', capacity: 'â€”', price: 'nuo 30 â‚¬', bg: '#fff5f0' }\n];\n\nfunction buildTrampolineGrid() {\n  let html = '<div class=\"chat-trampoline-grid\">';\n  for (const t of TRAMPOLINES) {\n    const thumb = t.img\n      ? '<img src=\"' + t.img + '\" alt=\"' + t.name + '\">'\n      : t.icon;\n    html += '<div class=\"chat-trampoline-select\" data-chat-option=\"' + t.name + '\" style=\"background:' + t.bg + '\">';\n    html += '<div class=\"chat-trampoline-thumb\">' + thumb + '</div>';\n    html += '<div class=\"chat-trampoline-info\">';\n    html += '<div class=\"t-name\">' + t.name + '</div>';\n    html += '<div class=\"t-meta\">' + t.type + ' Â· ' + t.capacity + '</div>';\n    html += '<div class=\"t-price\">' + t.price + '</div>';\n    html += '</div></div>';\n  }\n  html += '</div>';\n  return html;\n}\n\nfunction buildDatePicker() {\n  const days = [];\n  const now = new Date();\n  // Find next 4 Saturdays\n  const d = new Date(now);\n  d.setDate(d.getDate() + ((6 - d.getDay() + 7) % 7 || 7));\n  for (let i = 0; i < 4; i++) {\n    const iso = d.toISOString().split('T')[0];\n    const label = d.toLocaleDateString('lt-LT', { month: 'short', day: 'numeric', weekday: 'short' });\n    days.push('<button class=\"chat-option-btn\" data-chat-option=\"' + iso + '\">' + label + '</button>');\n    d.setDate(d.getDate() + 7);\n  }\n  let html = '<div class=\"chat-options\">' + days.join('') + '</div>';\n  html += '<input type=\"date\" class=\"chat-date-input\" data-chat-date min=\"' + now.toISOString().split('T')[0] + '\" placeholder=\"Kita data...\">';\n  html += '<button class=\"chat-date-confirm\" data-chat-date-confirm disabled>Patvirtinti datÄ…</button>';\n  return html;\n}\n\nfunction buildLocationOptions() {\n  const locs = ['TauragÄ—', 'Å ilalÄ—', 'Jurbarkas', 'PagÄ—giai', 'Raseiniai', 'Kitas miestas'];\n  let html = '<div class=\"chat-options\">';\n  for (const loc of locs) {\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + loc + '\">' + loc + '</button>';\n  }\n  html += '</div>';\n  return html;\n}\n\nfunction buildEventTypeOptions() {\n  const types = ['Gimtadienis', 'Å eimos Å¡ventÄ—', 'VieÅ¡as renginys', 'Ä®monÄ—s renginys', 'Kitas'];\n  let html = '<div class=\"chat-options\">';\n  for (const t of types) {\n    html += '<button class=\"chat-option-btn\" data-chat-option=\"' + t + '\">' + t + '</button>';\n  }\n  html += '</div>';\n  return html;\n}\n\nfunction buildBookingConfirm(jsonStr) {\n  let data;\n  try { data = JSON.parse(jsonStr); } catch { data = {}; }\n  let html = '<div class=\"booking-confirm\">';\n  html += '<h4>âœ… UÅ¾klausa pateikta!</h4>';\n  if (data.date) html += '<p><strong>Data:</strong> ' + data.date + '</p>';\n  if (data.location) html += '<p><strong>Vieta:</strong> ' + data.location + '</p>';\n  if (data.event_type) html += '<p><strong>Renginys:</strong> ' + data.event_type + '</p>';\n  if (data.contact_name) html += '<p><strong>Kontaktas:</strong> ' + data.contact_name + '</p>';\n  if (data.contact_phone) html += '<p><strong>Telefonas:</strong> ' + data.contact_phone + '</p>';\n  if (data.trampoline) html += '<p><strong>Batutas:</strong> ' + data.trampoline + '</p>';\n  html += '</div>';\n  return html;\n}\n\n// --- Check for markers and replace ---\nconst markers = [\n  { pattern: /\\[TRAMPOLINE_CATALOG\\]/g, fn: () => buildTrampolineGrid() },\n  { pattern: /\\[DATE_PICKER\\]/g, fn: () => buildDatePicker() },\n  { pattern: /\\[LOCATION_OPTIONS\\]/g, fn: () => buildLocationOptions() },\n  { pattern: /\\[EVENT_TYPE_OPTIONS\\]/g, fn: () => buildEventTypeOptions() }\n];\n\nlet hasMarker = false;\nlet enriched = response;\n\nfor (const m of markers) {\n  const before = enriched;\n  enriched = enriched.replace(m.pattern, m.fn);\n  if (enriched !== before) hasMarker = true;\n}\n\n// Handle BOOKING_CONFIRM separately (has capture group)\nconst confirmBefore = enriched;\nenriched = enriched.replace(/\\[BOOKING_CONFIRM:(\\{[^\\]]*\\})\\]/g, (match, jsonStr) => buildBookingConfirm(jsonStr));\nif (enriched !== confirmBefore) hasMarker = true;\n\nif (hasMarker) {\n  // Convert markdown bold and newlines\n  enriched = enriched.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n  enriched = enriched.replace(/\\n/g, '<br>');\n  enriched = '{{HTML}}<div class=\"chat-products\">' + enriched + '</div>';\n}\n\nreturn [{ json: { enriched } }];"
      },
      "id": "chat-enrich",
      "name": "Enrich Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json || {};\n\n// Check if enrichment produced output, otherwise fall back to agent output\nlet response = input.enriched;\n\nif (!response || !response.trim()) {\n  response = 'AtsipraÅ¡ome, Å¡iuo metu negaliu atsakyti. Susisiekite tiesiogiai: +370 686 55557 arba info@batutynas.lt';\n}\n\n// Truncate excessively long responses\nif (response.length > 10000) {\n  response = response.substring(0, 10000) + '...';\n}\n\nlet sessionId = '';\ntry {\n  sessionId = $('Extract Chat Input').item.json.sessionId;\n} catch (e) {\n  sessionId = 'unknown';\n}\n\nreturn [{\n  json: {\n    response: response,\n    session_id: sessionId\n  }\n}];"
      },
      "id": "chat-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 300]
    }
  ],
  "connections": {
    "Chat Webhook": {
      "main": [
        [
          {
            "node": "Extract Chat Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Chat Input": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude LLM": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Tool: Booking Notify": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Enrich Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enrich Response": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Batutynas Chat",
      "id": "batutynas-chat"
    }
  ],
  "triggerCount": 0,
  "versionId": "2"
}
